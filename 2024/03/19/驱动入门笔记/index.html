<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Linux驱动入门笔记 | Zero One</title><meta name="author" content="Primary"><meta name="copyright" content="Primary"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="简单的了解Linux驱动">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux驱动入门笔记">
<meta property="og:url" content="https://primaryo.github.io/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Zero One">
<meta property="og:description" content="简单的了解Linux驱动">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://primaryo.github.io/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121160513624.png">
<meta property="article:published_time" content="2024-03-19T09:36:10.729Z">
<meta property="article:modified_time" content="2024-03-19T09:40:36.686Z">
<meta property="article:author" content="Primary">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://primaryo.github.io/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121160513624.png"><link rel="shortcut icon" href="/./img/blogger.png"><link rel="canonical" href="https://primaryo.github.io/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":100},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Primary","link":"链接: ","source":"来源: Zero One","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux驱动入门笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-03-19 17:40:36'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/./img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope-open"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121160513624.png')"><nav id="nav"><span id="blog-info"><a href="/" title="Zero One"><span class="site-name">Zero One</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope-open"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux驱动入门笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-03-19T09:36:10.729Z" title="发表于 2024-03-19 17:36:10">2024-03-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-03-19T09:40:36.686Z" title="更新于 2024-03-19 17:40:36">2024-03-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>46分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Linux驱动入门笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-单片机和Linux程序从上层到底层的比较"><a href="#1-单片机和Linux程序从上层到底层的比较" class="headerlink" title="1 单片机和Linux程序从上层到底层的比较"></a>1 单片机和Linux程序从上层到底层的比较</h1><h2 id="1-程序比较"><a href="#1-程序比较" class="headerlink" title="1 程序比较"></a>1 程序比较</h2><ul>
<li><p>单片机程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	HAL库 / 寄存器操作	//直接操作硬件</span><br><span class="line">	R/W寄存器			  //可以直接读写寄存器</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Linux程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">应用程序：</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	无法直接R/W寄存器			  //不可以直接读写寄存器，因为有MMU，禁止直接访问内存</span><br><span class="line">	调用驱动程序 open/read/write...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">驱动程序：</span><br><span class="line">	open/read/write...</span><br><span class="line">	硬件操作</span><br><span class="line">	R/W寄存器			  //可以直接读写寄存器</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121150452014.png" alt="image-20231121150452014"></p>
<h2 id="2-调用过程"><a href="#2-调用过程" class="headerlink" title="2 调用过程"></a>2 调用过程</h2><ul>
<li>①应用程序<strong>调用open函数</strong></li>
<li>②open的实质是<strong>设置寄存器</strong>，<strong>执行一条汇编指令</strong>：swi #0，<strong>触发异常</strong>，还会在寄存器中保存一个值，如R0&#x3D;open</li>
<li>③cpu就会去执行swi异常处理函数，于是就从<strong>用户态陷入内核态</strong></li>
<li>④根据寄存器R0分辨调用的是什么函数，然后<strong>调用sys_open函数</strong>，判断文件名，通过主设备号找到驱动</li>
<li>⑤最后找到<strong>drv_open函数</strong></li>
</ul>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121160513624.png" alt="image-20231121160513624"></p>
<h2 id="3-打开设备节点"><a href="#3-打开设备节点" class="headerlink" title="3 打开设备节点"></a>3 打开设备节点</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd dev</span><br><span class="line">ls -l</span><br></pre></td></tr></table></figure>

<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121154233396.png" alt="image-20231121154233396"></p>
<h2 id="4-查看支持的设备"><a href="#4-查看支持的设备" class="headerlink" title="4 查看支持的设备"></a>4 查看支持的设备</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/devices</span><br></pre></td></tr></table></figure>



<h2 id="5-如何写驱动"><a href="#5-如何写驱动" class="headerlink" title="5 如何写驱动"></a>5 如何写驱动</h2><ul>
<li>确定主设备号</li>
<li>构造结构体file_operations，实现其中的函数</li>
<li>注册结构体，放入到chrdev[]数组中</li>
<li>入口</li>
</ul>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121160006224.png" alt="image-20231121160006224"></p>
<h1 id="2-彻底分析第一个驱动程序"><a href="#2-彻底分析第一个驱动程序" class="headerlink" title="2 彻底分析第一个驱动程序"></a>2 彻底分析第一个驱动程序</h1><h2 id="1-在Ubuntu中速体验驱动开发"><a href="#1-在Ubuntu中速体验驱动开发" class="headerlink" title="1 在Ubuntu中速体验驱动开发"></a>1 在Ubuntu中速体验驱动开发</h2><ul>
<li><p>下载内核头文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uname -r										 // 查看内核版本</span><br><span class="line">apt-cache search linux-headers-$(uname -r)       // 确认有没有</span><br><span class="line">sudo apt-get install linux-headers-$(uname -r)	 // 下载安装</span><br><span class="line">/lib/modules/5.19.0-41-generic/build			 // ubuntu内核头文件所在目录</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2-驱动程序"><a href="#2-驱动程序" class="headerlink" title="2 驱动程序"></a>2 驱动程序</h2><h4 id="V1-最简单的驱动程序"><a href="#V1-最简单的驱动程序" class="headerlink" title="V1 最简单的驱动程序"></a>V1 最简单的驱动程序</h4><p>hello_drv.c：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line"></span><br><span class="line">int init_module(void)  //直接使用init_module</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void cleanup_module(void)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line"></span><br><span class="line">//module_init(hello_init);</span><br><span class="line">//int init_module(void) __attribute__((alias(hello_init)));</span><br></pre></td></tr></table></figure>

<p>Makefile:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ARCH = x86</span><br><span class="line">CROSS_COMPILE =</span><br><span class="line"></span><br><span class="line">KVERSION = $(shell uname -r)</span><br><span class="line">KERN_DIR =  /lib/modules/$(KVERSION)/build </span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">	make -C $(KERN_DIR) M=`pwd` modules </span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	make -C $(KERN_DIR) M=`pwd` modules clean</span><br><span class="line">	rm -rf modules.order</span><br><span class="line"></span><br><span class="line">obj-m	+= hello_drv.o</span><br></pre></td></tr></table></figure>

<h4 id="V2-驱动入口、出口详解"><a href="#V2-驱动入口、出口详解" class="headerlink" title="V2 驱动入口、出口详解"></a>V2 驱动入口、出口详解</h4><ul>
<li>__init 段属性，只用一次，可释放</li>
<li>__exit 段属性，驱动编进内核里才有意义，无需出口，出口函数无意义，在一般的ko文件中无意义，段属性，但是不会链接进内核</li>
</ul>
<p>hello_drv.c：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line"></span><br><span class="line">//__init 段属性，只用一次，可释放</span><br><span class="line">int __init hello_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;hello drv init\n&quot;);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//__exit 段属性，但是不会链接进内核</span><br><span class="line">//驱动编进内核里才有意义，无需出口，出口函数无意义，在一般的ko文件中无意义</span><br><span class="line">void __exit hello_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;hello drv exit\n&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br><span class="line"></span><br><span class="line">//int init_module(void) __attribute__((alias(hello_init)));</span><br></pre></td></tr></table></figure>

<p>Makefile:同上</p>
<h4 id="V3-字符设备调用关系"><a href="#V3-字符设备调用关系" class="headerlink" title="V3 字符设备调用关系"></a>V3 字符设备调用关系</h4><ul>
<li>驱动不提供open，应用程序调用open也能打开驱动文件</li>
<li>但是不提供read、write，应用程序调用read、write就会报错</li>
</ul>
<p>hello_drv.c：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line"></span><br><span class="line">static int major = 0;</span><br><span class="line"></span><br><span class="line">static struct file_operations hello_fops = &#123;</span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int __init hello_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;hello drv init\n&quot;);</span><br><span class="line">	major = register_chrdev(0, &quot;hello_drv&quot;, &amp;hello_fops);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __exit hello_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;hello drv exit\n&quot;);</span><br><span class="line">	unregister_chrdev(major, &quot;hello_drv&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>

<p>hello_test.c:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * ./hello_drv_test -w abc</span><br><span class="line"> * ./hello_drv_test -r</span><br><span class="line"> */</span><br><span class="line">int main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">	int fd;</span><br><span class="line">	char buf[1024];</span><br><span class="line">	int len;</span><br><span class="line">	int ret;</span><br><span class="line">	</span><br><span class="line">	/* 1. 判断参数 */</span><br><span class="line">	if (argc &lt; 2) </span><br><span class="line">	&#123;</span><br><span class="line">		printf(&quot;Usage: %s -w &lt;string&gt;\n&quot;, argv[0]);</span><br><span class="line">		printf(&quot;       %s -r\n&quot;, argv[0]);</span><br><span class="line">		return -1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* 2. 打开文件 */</span><br><span class="line">	fd = open(&quot;/dev/xyz&quot;, O_RDWR);</span><br><span class="line">	if (fd == -1)</span><br><span class="line">	&#123;</span><br><span class="line">		printf(&quot;can not open file /dev/xyz\n&quot;);</span><br><span class="line">		return -1;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	printf(&quot;open file /dev/xyz ok\n&quot;);</span><br><span class="line"></span><br><span class="line">	/* 3. 写文件或读文件 */</span><br><span class="line">	if ((0 == strcmp(argv[1], &quot;-w&quot;)) &amp;&amp; (argc == 3))</span><br><span class="line">	&#123;</span><br><span class="line">		len = strlen(argv[2]) + 1;</span><br><span class="line">		len = len &lt; 1024 ? len : 1024;</span><br><span class="line">		ret = write(fd, argv[2], len);</span><br><span class="line">		printf(&quot;write driver: %d\n&quot;, ret);</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		len = read(fd, buf, 1024);		</span><br><span class="line">		printf(&quot;read driver: %d\n&quot;, len);</span><br><span class="line">		buf[1023] = &#x27;\0&#x27;;</span><br><span class="line">		printf(&quot;APP read : %s\n&quot;, buf);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	close(fd);</span><br><span class="line">	</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="V4-数据交互"><a href="#V4-数据交互" class="headerlink" title="V4 数据交互"></a>V4 数据交互</h4><ul>
<li>copy_to_user</li>
<li>copy_from_user</li>
</ul>
<p>hello_drv.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/uaccess.h&gt;</span><br><span class="line">//#include &lt;asm/uaccess.h&gt;</span><br><span class="line"></span><br><span class="line">static int major = 0;</span><br><span class="line">static int ker_val = 123;</span><br><span class="line"></span><br><span class="line">static ssize_t hello_read (struct file *file, char __user *buf, size_t size, loff_t *offset)</span><br><span class="line">&#123;</span><br><span class="line">	int err;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">	copy_to_user(buf, &amp;ker_val, 4);</span><br><span class="line">	return 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static ssize_t hello_write (struct file *file, const char __user *buf, size_t size, loff_t *offset)</span><br><span class="line">&#123;</span><br><span class="line">	int err;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">	copy_from_user(&amp;ker_val, buf, 4);</span><br><span class="line">	return 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static struct file_operations hello_fops = &#123;</span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">	.read       = hello_read,</span><br><span class="line">	.write      = hello_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int __init hello_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;hello drv init\n&quot;);</span><br><span class="line">	major = register_chrdev(0, &quot;hello_drv&quot;, &amp;hello_fops);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __exit hello_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;hello drv exit\n&quot;);</span><br><span class="line">	unregister_chrdev(major, &quot;hello_drv&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>



<h1 id="3-驱动程序辅助信息及地址空间概念"><a href="#3-驱动程序辅助信息及地址空间概念" class="headerlink" title="3 驱动程序辅助信息及地址空间概念"></a>3 驱动程序辅助信息及地址空间概念</h1><h2 id="1-思考"><a href="#1-思考" class="headerlink" title="1 思考"></a>1 思考</h2><p>GIT仓库中有如下程序：</p>
<p>adress.c源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;val&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	a = strtol(argv[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;a = %d\n&quot;</span>, a);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;a&#x27;s address = 0x%lx\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)&amp;a);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;main&#x27;s address = 0x%lx\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)main);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		sleep(<span class="number">100</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把它放到Ubuntu后，执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./address 124&amp;</span></span><br><span class="line">a = 124</span><br><span class="line">a&#x27;s address = 0x6bc3a0</span><br><span class="line">main&#x27;s address = 0x400b5d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./address 123&amp;</span></span><br><span class="line">a = 123</span><br><span class="line">a&#x27;s address = 0x6bc3a0</span><br><span class="line">main&#x27;s address = 0x400b5d</span><br></pre></td></tr></table></figure>

<p>观察到：现在内存里有2个address程序，它们的变量a地址相同、值不同</p>
<p>问：为什么同一个地址的内存里，同一时间点，竟然值不一样？</p>
<h2 id="2-地址空间"><a href="#2-地址空间" class="headerlink" title="2. 地址空间"></a>2. 地址空间</h2><h3 id="1-CPU怎么访问多个外设"><a href="#1-CPU怎么访问多个外设" class="headerlink" title="1 CPU怎么访问多个外设"></a>1 CPU怎么访问多个外设</h3><h4 id="MCU"><a href="#MCU" class="headerlink" title="MCU"></a>MCU</h4><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121185750327.png" alt="image-20231121185750327"></p>
<h4 id="MPU"><a href="#MPU" class="headerlink" title="MPU"></a>MPU</h4><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121190133851.png" alt="image-20231121190133851"></p>
<h3 id="2-为什么要引入虚拟地址"><a href="#2-为什么要引入虚拟地址" class="headerlink" title="2 为什么要引入虚拟地址"></a>2 为什么要引入虚拟地址</h3><ul>
<li>如果main函数调用 f 函数，就需要用到 f1 的地址（虚拟地址）</li>
<li>链接时，要确定 f1 的地址（虚拟地址）</li>
<li>运行时，f1 所在内存的地址可能不一样（物理地址）</li>
</ul>
<p>当引入虚拟地址后：</p>
<ul>
<li>加载程序（物理地址）</li>
<li>映射，链接地址（虚拟地址）</li>
<li>运行，跳到虚拟地址去运行</li>
</ul>
<h3 id="3-虚拟地址怎么对应到物理地址"><a href="#3-虚拟地址怎么对应到物理地址" class="headerlink" title="3 虚拟地址怎么对应到物理地址"></a>3 虚拟地址怎么对应到物理地址</h3><p>virAdress &#x3D; ioremap（phyAdress，4）</p>
<h3 id="4-Linux驱动中怎么访问硬件寄存器"><a href="#4-Linux驱动中怎么访问硬件寄存器" class="headerlink" title="4 Linux驱动中怎么访问硬件寄存器"></a>4 Linux驱动中怎么访问硬件寄存器</h3><h2 id="3-驱动程序辅助信息"><a href="#3-驱动程序辅助信息" class="headerlink" title="3 驱动程序辅助信息"></a>3 驱动程序辅助信息</h2><p>自动创建设备节点的流程：</p>
<ul>
<li>内核提供信息<ul>
<li>class_create</li>
<li>device_create</li>
</ul>
</li>
<li>APP根据信息创建设备节点</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/uaccess.h&gt;</span><br><span class="line">//#include &lt;asm/uaccess.h&gt;</span><br><span class="line">#include &lt;linux/device.h&gt;</span><br><span class="line"></span><br><span class="line">static int major = 0;</span><br><span class="line">static int ker_val = 123;</span><br><span class="line">static struct class *class_for_hello;</span><br><span class="line"></span><br><span class="line">static ssize_t hello_read (struct file *file, char __user *buf, size_t size, loff_t *offset)</span><br><span class="line">&#123;</span><br><span class="line">	int err;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">	copy_to_user(buf, &amp;ker_val, 4);</span><br><span class="line">	return 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static ssize_t hello_write (struct file *file, const char __user *buf, size_t size, loff_t *offset)</span><br><span class="line">&#123;</span><br><span class="line">	int err;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">	copy_from_user(&amp;ker_val, buf, 4);</span><br><span class="line">	return 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static struct file_operations hello_fops = &#123;</span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">	.read       = hello_read,</span><br><span class="line">	.write      = hello_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int __init hello_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;hello drv init\n&quot;);</span><br><span class="line">	major = register_chrdev(0, &quot;hello_drv&quot;, &amp;hello_fops);</span><br><span class="line">	class_for_hello = class_create(THIS_MODULE, &quot;hello_class&quot;); /* /sys/class/hello_class/ */</span><br><span class="line">	device_create(class_for_hello, NULL, MKDEV(major, 0), NULL, &quot;myhello&quot;); /* /dev/myhello */</span><br><span class="line">	</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void __exit hello_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;hello drv exit\n&quot;);</span><br><span class="line">	device_destroy(class_for_hello, MKDEV(major, 0)); /* /dev/myhello */</span><br><span class="line">	</span><br><span class="line">	class_destroy(class_for_hello);</span><br><span class="line">	</span><br><span class="line">	unregister_chrdev(major, &quot;hello_drv&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br><span class="line"></span><br><span class="line">//int init_module(void) __attribute__((alias(hello_init)));</span><br></pre></td></tr></table></figure>



<h1 id="4-板子上驱动程序实际操作及编译过程"><a href="#4-板子上驱动程序实际操作及编译过程" class="headerlink" title="4 板子上驱动程序实际操作及编译过程"></a>4 板子上驱动程序实际操作及编译过程</h1><h3 id="1-在内核目录外编译模块"><a href="#1-在内核目录外编译模块" class="headerlink" title="1 在内核目录外编译模块"></a>1 在内核目录外编译模块</h3><p>led_drv.c源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#include &lt;linux/kernel.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/slab.h&gt;</span><br><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/delay.h&gt;</span><br><span class="line">#include &lt;linux/poll.h&gt;</span><br><span class="line">#include &lt;linux/mutex.h&gt;</span><br><span class="line">#include &lt;linux/wait.h&gt;</span><br><span class="line">#include &lt;linux/uaccess.h&gt;</span><br><span class="line">#include &lt;asm/io.h&gt;</span><br><span class="line"></span><br><span class="line">static int major;</span><br><span class="line">static struct class *led_class;</span><br><span class="line"></span><br><span class="line">static ssize_t led_write(struct file *filp, const char __user *buf,</span><br><span class="line">			 size_t count, loff_t *ppos)</span><br><span class="line">&#123;</span><br><span class="line">	char val;</span><br><span class="line">	/* copy_from_user : get data from app */</span><br><span class="line">	copy_from_user(&amp;val, buf, 1);</span><br><span class="line"></span><br><span class="line">	/* to set gpio register: out 1/0 */</span><br><span class="line">	if (val)</span><br><span class="line">	&#123;</span><br><span class="line">		/* set gpio to let led on */</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		/* set gpio to let led off */</span><br><span class="line">	&#125;</span><br><span class="line">	return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int led_open(struct inode *inode, struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">	/* enable gpio</span><br><span class="line">	 * configure pin as gpio</span><br><span class="line">	 * configure gpio as output </span><br><span class="line">	 */</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static struct file_operations led_fops = &#123;</span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">	.write		= led_write,</span><br><span class="line">	.open		= led_open,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/* 入口函数 */</span><br><span class="line">static int __init led_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;%s %s %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">	</span><br><span class="line">	major = register_chrdev(0, &quot;100ask_led&quot;, &amp;led_fops);</span><br><span class="line"></span><br><span class="line">	/* ioremap */</span><br><span class="line"></span><br><span class="line">	led_class = class_create(THIS_MODULE, &quot;myled&quot;);</span><br><span class="line">	device_create(led_class, NULL, MKDEV(major, 0), NULL, &quot;myled&quot;); /* /dev/myled */</span><br><span class="line">	</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void __exit led_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	device_destroy(led_class, MKDEV(major, 0));</span><br><span class="line">	class_destroy(led_class);</span><br><span class="line">	</span><br><span class="line">	unregister_chrdev(major, &quot;100ask_led&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(led_init);</span><br><span class="line">module_exit(led_exit);</span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br></pre></td></tr></table></figure>

<p>Makefile源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 1. 使用不同的开发板内核时, 一定要修改KERN_DIR</span><br><span class="line"># 2. KERN_DIR中的内核要事先配置、编译, 为了能编译内核, 要先设置下列环境变量:</span><br><span class="line"># 2.1 ARCH,          比如: export ARCH=arm64</span><br><span class="line"># 2.2 CROSS_COMPILE, 比如: export CROSS_COMPILE=aarch64-linux-gnu-</span><br><span class="line"># 2.3 PATH,          比如: export PATH=$PATH:/home/book/100ask_roc-rk3399-pc/ToolChain-6.3.1/gcc-linaro-6.3.1-2017.05-x86_64_aarch64-linux-gnu/bin </span><br><span class="line"># 注意: 不同的开发板不同的编译器上述3个环境变量不一定相同,</span><br><span class="line">#请参考各开发板的高级用户使用手册</span><br><span class="line"></span><br><span class="line">KERN_DIR = </span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">	make -C $(KERN_DIR) M=`pwd` modules       </span><br><span class="line">	$(CROSS_COMPILE)gcc -o ledtest ledtest.c </span><br><span class="line"></span><br><span class="line"># -C 表示changedir，进入到$(KERN_DIR)目录，编译 M 路径中的模块</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	make -C $(KERN_DIR) M=`pwd` modules clean</span><br><span class="line">	rm -rf modules.order</span><br><span class="line">	rm -f ledtest</span><br><span class="line"></span><br><span class="line">obj-m	+= led_drv.o</span><br><span class="line">#需要编译的模块</span><br></pre></td></tr></table></figure>

<p>imx6ull开发板环境变量如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=arm</span><br><span class="line">export CROSS_COMPILE=arm-linux-gnueabihf-</span><br><span class="line">export PATH=$PATH:/usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/bin </span><br></pre></td></tr></table></figure>



<h3 id="2-在内核目录里面编译驱动"><a href="#2-在内核目录里面编译驱动" class="headerlink" title="2 在内核目录里面编译驱动"></a>2 在内核目录里面编译驱动</h3><ul>
<li><p>将需要编译进内核的驱动源码放入到内核目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp led_drv.c /home/lk/linux/imx6ull/3.linux_kernel/kernel/alpha_kernel/linux-imx-rel_imx_4.1.15_2.1.0_ga/drivers/char</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改内核目录下&#x2F;drivers&#x2F;char&#x2F;Kconfig，添加相应的配置信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config ALPHA_LED</span><br><span class="line">	bool &quot;led driver for alpha&quot;</span><br><span class="line">	default y</span><br><span class="line">	help</span><br><span class="line">	  Just for test led.</span><br></pre></td></tr></table></figure>

<p>也可以打开menuconfig来配置</p>
<p>make menuconfig</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Device Drivers</span><br><span class="line">	Character devices</span><br><span class="line">		led driver for alpha</span><br><span class="line">			m 编译为模块</span><br><span class="line">			y 编译进内核</span><br><span class="line">			n 不参与编译</span><br></pre></td></tr></table></figure>

<p>在内核根目录下的.config文件中可以看到 CONFIG_ALPHA_LED &#x3D; y</p>
</li>
<li><p>修改内核目录下&#x2F;drivers&#x2F;char&#x2F;Makefile，添加相应的配置信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-$(CONFIG_ALPHA_LED)     += gpioled.o</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译zImage，烧写到开发板，即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make zImage -j4</span><br><span class="line">cp /arch/arm/boot/zImage   /home/lk/linux/tftpboot -rf    	 //拷贝zImage</span><br><span class="line">cp /arch/arm/boot/dts/.dtb /home/lk/linux/tftpboot -rf   	 //拷贝dtb</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="5-分离的设计思想与总线设备驱动模型"><a href="#5-分离的设计思想与总线设备驱动模型" class="headerlink" title="5 分离的设计思想与总线设备驱动模型"></a>5 分离的设计思想与总线设备驱动模型</h1><h2 id="1-分离的设计思想"><a href="#1-分离的设计思想" class="headerlink" title="1 分离的设计思想"></a>1 分离的设计思想</h2><p>一个驱动可以适应很多个设备，就可以把驱动与设备分离开</p>
<p>驱动程序分成两部分：</p>
<ul>
<li>驱动：通用的驱动信息</li>
<li>设备：硬件信息</li>
</ul>
<h2 id="2-总线设备驱动模型"><a href="#2-总线设备驱动模型" class="headerlink" title="2 总线设备驱动模型"></a>2 总线设备驱动模型</h2><ul>
<li>platform_bus_type  总线platform下面有两个链表<ul>
<li>driver_list   驱动链表</li>
<li>device_list  设备链表</li>
</ul>
</li>
</ul>
<h2 id="3-编写驱动方法"><a href="#3-编写驱动方法" class="headerlink" title="3 编写驱动方法"></a>3 编写驱动方法</h2><p>①构造，注册</p>
<ul>
<li>构造platform_driver，注册进驱动链表</li>
<li>构造platform_device，注册进设备链表</li>
</ul>
<p>②匹配，跟对方链表的每个成员一一比较，调用platform总线里面的 .match 函数比较</p>
<p>③匹配成功，就会执行platform_driver里面的 .probe 函数</p>
<h1 id="6-总线设备驱动模型彻底分析"><a href="#6-总线设备驱动模型彻底分析" class="headerlink" title="6 总线设备驱动模型彻底分析"></a>6 总线设备驱动模型彻底分析</h1><h2 id="1-匹配方法"><a href="#1-匹配方法" class="headerlink" title="1 匹配方法"></a>1 匹配方法</h2><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121211955147.png" alt="image-20231121211955147"></p>
<h2 id="2-注册过程"><a href="#2-注册过程" class="headerlink" title="2 注册过程"></a>2 注册过程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">platform_driver_register 注册设备</span><br><span class="line">	platform_device_add</span><br><span class="line">		pdev-&gt;dev.bus = &amp;platform_bus_type;</span><br><span class="line">		ret = device_add(&amp;pdev-&gt;dev);</span><br><span class="line">			error = bus_add_device(dev);</span><br><span class="line">				klist_add_tail		 将设备放入总线设备链表</span><br><span class="line">					bus_probe_device 枚举设备</span><br><span class="line">						device_initial_prove</span><br><span class="line">							__device_attach</span><br><span class="line">								bus_for_each_drv 对于总线下面的每一个驱动</span><br><span class="line">									__device_attch_driver 调用该函数查看是否匹配驱动				</span><br></pre></td></tr></table></figure>



<h2 id="3-私有数据"><a href="#3-私有数据" class="headerlink" title="3 私有数据"></a>3 私有数据</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">platform_set_drvdata()   //设置与驱动有关的私有数据</span><br></pre></td></tr></table></figure>



<h1 id="7-设备树入门"><a href="#7-设备树入门" class="headerlink" title="7 设备树入门"></a>7 设备树入门</h1><p>设备文件过多，而且也不是内核中的核心文件，会导致内核臃肿，而且修改麻烦</p>
<p>所以引入一个配置文件，内核可以读取这个配置文件，就相当于读取设备文件，也就设备树</p>
<h2 id="1-反汇编dtb文件"><a href="#1-反汇编dtb文件" class="headerlink" title="1 反汇编dtb文件"></a>1 反汇编dtb文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dtc -I dtb -O dts imx6ull-alpha.dtb &gt; 1.dts</span><br></pre></td></tr></table></figure>

<h2 id="2-设备树节点语法"><a href="#2-设备树节点语法" class="headerlink" title="2 设备树节点语法"></a>2 设备树节点语法</h2><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121220113106.png" alt="image-20231121220113106"></p>
<h2 id="3-创建设备树节点"><a href="#3-创建设备树节点" class="headerlink" title="3 创建设备树节点"></a>3 创建设备树节点</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">myled: myled_test &#123;</span><br><span class="line">	pin = &quot;gpio5_3&quot;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">myled_ok: myled_ok_test &#123;</span><br><span class="line">	compatible = &quot;fsl,led&quot;		//有compatible属性的节点才能转换成platform_device</span><br><span class="line">	pin = &quot;gpio5_3&quot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/sys/firmware/devicetree/base 	//该目录下有设备树节点的信息myled_test、myled_ok_test</span><br><span class="line">/sys/bus/platform/devices		//该目录下有平台设备的信息myled_ok_test</span><br></pre></td></tr></table></figure>

<h2 id="4-设备树匹配过程"><a href="#4-设备树匹配过程" class="headerlink" title="4 设备树匹配过程"></a>4 设备树匹配过程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">of_driver_match_device(dev,drv)</span><br><span class="line">	of_match_device(drv-&gt;of_match_table, dev)  //驱动里面的of_match_device放有compatible</span><br></pre></td></tr></table></figure>



<h1 id="8-设备树示例"><a href="#8-设备树示例" class="headerlink" title="8 设备树示例"></a>8 设备树示例</h1><h2 id="1-LED和按键的设备树示例"><a href="#1-LED和按键的设备树示例" class="headerlink" title="1 LED和按键的设备树示例"></a>1 LED和按键的设备树示例</h2><p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull-alpha.dts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dtsled &#123;</span><br><span class="line">		compatible = &quot;gpio-leds&quot;;				//根据该属性找对应的驱动程序</span><br><span class="line"></span><br><span class="line">		led0 &#123;</span><br><span class="line">			label= &quot;red&quot;;</span><br><span class="line">			gpios = &lt;&amp;gpio1 3 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">			linux,default-trigger = &quot;heartbeat&quot;;</span><br><span class="line">			default-state = &quot;on&quot;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">gpio-keys &#123;</span><br><span class="line">		compatible = &quot;gpio-keys&quot;;			//根据该属性找对应的驱动程序</span><br><span class="line">		#address-cells = &lt;1&gt;;</span><br><span class="line">		#size-cells = &lt;0&gt;;</span><br><span class="line">		autorepeat;</span><br><span class="line"></span><br><span class="line">		led0 &#123;</span><br><span class="line">			label= &quot;GPIO Key Enter&quot;;</span><br><span class="line">			linux,code = &lt;KEY_ENTER&gt;;</span><br><span class="line">			gpios = &lt;&amp;gpio1 18 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="2-I2C设备树示例"><a href="#2-I2C设备树示例" class="headerlink" title="2 I2C设备树示例"></a>2 I2C设备树示例</h2><p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull.dtsi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">i2c1: i2c@021a0000 &#123;</span><br><span class="line">				#address-cells = &lt;1&gt;;</span><br><span class="line">				#size-cells = &lt;0&gt;;</span><br><span class="line">				compatible = &quot;fsl,imx6ul-i2c&quot;, &quot;fsl,imx21-i2c&quot;;		//I2C相关驱动</span><br><span class="line">				reg = &lt;0x021a0000 0x4000&gt;;							//寄存器基地址+长度</span><br><span class="line">				interrupts = &lt;GIC_SPI 36 IRQ_TYPE_LEVEL_HIGH&gt;;		//中断</span><br><span class="line">				clocks = &lt;&amp;clks IMX6UL_CLK_I2C1&gt;;					//时钟</span><br><span class="line">				status = &quot;disabled&quot;;								//状态</span><br><span class="line">			&#125;;</span><br></pre></td></tr></table></figure>

<p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull-alpha.dts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c1 &#123;</span><br><span class="line">	clock-frequency = &lt;100000&gt;;				//频率</span><br><span class="line">	pinctrl-names = &quot;default&quot;;				</span><br><span class="line">	pinctrl-0 = &lt;&amp;pinctrl_i2c1&gt;;			//引脚信息</span><br><span class="line">	status = &quot;okay&quot;;						//状态</span><br><span class="line"></span><br><span class="line">	ap3216c@1e &#123; 							//在I2C1下面的具体设备，I2C1的子节点</span><br><span class="line">		compatible = &quot;alpha,ap3216c&quot;; 		//具体设备的驱动</span><br><span class="line">		reg = &lt;0x1e&gt;; 						//设备地址</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	oled@3c &#123; </span><br><span class="line">		compatible = &quot;alpha,oled&quot;; </span><br><span class="line">		reg = &lt;0x3c&gt;; </span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	codec: wm8960@1a &#123; </span><br><span class="line">		compatible = &quot;wlf,wm8960&quot;; </span><br><span class="line">		reg = &lt;0x1a&gt;; </span><br><span class="line">		clocks = &lt;&amp;clks IMX6UL_CLK_SAI2&gt;; </span><br><span class="line">		clock-names = &quot;mclk&quot;; </span><br><span class="line">		wlf,shared-lrclk; </span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="3-SPI设备树示例"><a href="#3-SPI设备树示例" class="headerlink" title="3 SPI设备树示例"></a>3 SPI设备树示例</h2><p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull.dtsi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ecspi3: ecspi@02010000 &#123;</span><br><span class="line">					#address-cells = &lt;1&gt;;</span><br><span class="line">					#size-cells = &lt;0&gt;;</span><br><span class="line">					compatible = &quot;fsl,imx6ul-ecspi&quot;, &quot;fsl,imx51-ecspi&quot;;</span><br><span class="line">					reg = &lt;0x02010000 0x4000&gt;;</span><br><span class="line">					interrupts = &lt;GIC_SPI 33 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">					clocks = &lt;&amp;clks IMX6UL_CLK_ECSPI3&gt;,</span><br><span class="line">						 &lt;&amp;clks IMX6UL_CLK_ECSPI3&gt;;</span><br><span class="line">					clock-names = &quot;ipg&quot;, &quot;per&quot;;</span><br><span class="line">					dmas = &lt;&amp;sdma 7 7 1&gt;, &lt;&amp;sdma 8 7 2&gt;;</span><br><span class="line">					dma-names = &quot;rx&quot;, &quot;tx&quot;;</span><br><span class="line">					status = &quot;disabled&quot;;</span><br><span class="line">				&#125;;</span><br></pre></td></tr></table></figure>

<p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull-alpha.dts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&amp;ecspi3 &#123;</span><br><span class="line">	fsl,spi-num-chipselects = &lt;1&gt;;           //设置当前片选数量为 1</span><br><span class="line">	cs-gpios = &lt;&amp;gpio1 20 GPIO_ACTIVE_LOW&gt;;  //描述片选引脚</span><br><span class="line">	pinctrl-names = &quot;default&quot;;</span><br><span class="line">	pinctrl-0 = &lt;&amp;pinctrl_ecspi3&gt;;           //设置 IO 要使用的 pinctrl 子节点</span><br><span class="line">	status = &quot;okay&quot;;</span><br><span class="line"></span><br><span class="line">	spidev: icm20608@0 &#123; </span><br><span class="line">		compatible = &quot;alientek,icm20608&quot;; </span><br><span class="line">		spi-max-frequency = &lt;8000000&gt;;      //设置 SPI 最大时钟频率为 8MHz</span><br><span class="line">		reg = &lt;0&gt;;                          //icm20608 连接在 ECSPI3 的第 0 个通道上</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="4-LCD设备树示例"><a href="#4-LCD设备树示例" class="headerlink" title="4 LCD设备树示例"></a>4 LCD设备树示例</h2><p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull.dtsi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">lcdif: lcdif@021c8000 &#123;</span><br><span class="line">				compatible = &quot;fsl,imx6ul-lcdif&quot;, &quot;fsl,imx28-lcdif&quot;;</span><br><span class="line">				reg = &lt;0x021c8000 0x4000&gt;;</span><br><span class="line">				interrupts = &lt;GIC_SPI 5 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">				clocks = &lt;&amp;clks IMX6UL_CLK_LCDIF_PIX&gt;,</span><br><span class="line">					 &lt;&amp;clks IMX6UL_CLK_LCDIF_APB&gt;,</span><br><span class="line">					 &lt;&amp;clks IMX6UL_CLK_DUMMY&gt;;</span><br><span class="line">				clock-names = &quot;pix&quot;, &quot;axi&quot;, &quot;disp_axi&quot;;</span><br><span class="line">				status = &quot;disabled&quot;;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull-alpha.dts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&amp;lcdif &#123;</span><br><span class="line">	pinctrl-names = &quot;default&quot;;</span><br><span class="line">	pinctrl-0 = &lt;&amp;pinctrl_lcdif_dat</span><br><span class="line">		     &amp;pinctrl_lcdif_ctrl&gt;;</span><br><span class="line">	display = &lt;&amp;display0&gt;;</span><br><span class="line">	status = &quot;okay&quot;;</span><br><span class="line"></span><br><span class="line">	display0: display &#123;</span><br><span class="line">		bits-per-pixel = &lt;24&gt;;</span><br><span class="line">		bus-width = &lt;24&gt;;</span><br><span class="line"></span><br><span class="line">		display-timings &#123;</span><br><span class="line">			native-mode = &lt;&amp;timing0&gt;;</span><br><span class="line">			timing0: timing0 &#123;</span><br><span class="line">			clock-frequency = &lt;34200000&gt;;   /* LCD 像素时钟，单位 Hz */ </span><br><span class="line">			hactive = &lt;800&gt;;                /* LCD X 轴像素个数 */</span><br><span class="line">			vactive = &lt;480&gt;;                /* LCD Y 轴像素个数 */</span><br><span class="line">			hfront-porch = &lt;210&gt;; 			/* LCD hfp 参数 */</span><br><span class="line">			hback-porch = &lt;46&gt;;				/* LCD hbp 参数 */</span><br><span class="line">			hsync-len = &lt;1&gt;;				/* LCD hspw 参数 */ </span><br><span class="line">			vback-porch = &lt;23&gt;;				/* LCD vbp 参数 */</span><br><span class="line">			vfront-porch = &lt;22&gt;;			/* LCD vfp 参数 */</span><br><span class="line">			vsync-len = &lt;1&gt;;				/* LCD vspw 参数 */</span><br><span class="line"></span><br><span class="line">			hsync-active = &lt;0&gt;;</span><br><span class="line">			vsync-active = &lt;0&gt;;</span><br><span class="line">			de-active = &lt;1&gt;;</span><br><span class="line">			pixelclk-active = &lt;0&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="5-设备树编写方法"><a href="#5-设备树编写方法" class="headerlink" title="5 设备树编写方法"></a>5 设备树编写方法</h2><ul>
<li>使用芯片厂家提供的工具 </li>
<li>看绑定文档</li>
<li>参考同类型单板的设备树文件 </li>
<li>网上搜索</li>
<li>实在没办法时, 只能去研究驱动源码</li>
</ul>
<h1 id="9-Pinctrl和GPIO"><a href="#9-Pinctrl和GPIO" class="headerlink" title="9 Pinctrl和GPIO"></a>9 Pinctrl和GPIO</h1><h2 id="1-Pinctrl"><a href="#1-Pinctrl" class="headerlink" title="1 Pinctrl"></a>1 Pinctrl</h2><ul>
<li><p>imx6ull为例</p>
<p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull-alpha.dts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gpioled &#123;</span><br><span class="line">		#address-cells = &lt;1&gt;;</span><br><span class="line">		#size-cells = &lt;1&gt;;</span><br><span class="line">		compatible = &quot;alpha-gpioled&quot;;</span><br><span class="line">		pinctrl-names = &quot;default&quot;;</span><br><span class="line">		</span><br><span class="line">		pinctrl-0 = &lt;&amp;pinctrl_led&gt;;				//Pinctrl</span><br><span class="line">		</span><br><span class="line">		led-gpio = &lt;&amp;gpio1 3 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		status = &quot;okay&quot;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_led: ledgrp &#123;</span><br><span class="line">			fsl,pins = &lt;</span><br><span class="line">				MX6UL_PAD_GPIO1_IO03__GPIO1_IO03  0x10B0          /*config 是具体设置值*/</span><br><span class="line">			&gt;;</span><br><span class="line">		&#125;;</span><br><span class="line">		</span><br><span class="line">&quot;imx6ull-pinfunc.h&quot;</span><br><span class="line">#define MX6UL_PAD_GPIO1_IO03__GPIO1_IO03                          0x0068 0x02F4 0x0000 0x5 0x0</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2-GPIO"><a href="#2-GPIO" class="headerlink" title="2 GPIO"></a>2 GPIO</h2><p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull-alpha.dts</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gpioled &#123;</span><br><span class="line">		#address-cells = &lt;1&gt;;</span><br><span class="line">		#size-cells = &lt;1&gt;;</span><br><span class="line">		compatible = &quot;alpha-gpioled&quot;;</span><br><span class="line">		pinctrl-names = &quot;default&quot;;	</span><br><span class="line">		pinctrl-0 = &lt;&amp;pinctrl_led&gt;;</span><br><span class="line">		</span><br><span class="line">		led-gpio = &lt;&amp;gpio1 3 GPIO_ACTIVE_LOW&gt;;		//GPIO</span><br><span class="line">		</span><br><span class="line">		status = &quot;okay&quot;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull.dtsi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gpio1: gpio@0209c000 &#123;</span><br><span class="line">				compatible = &quot;fsl,imx6ul-gpio&quot;, &quot;fsl,imx35-gpio&quot;;</span><br><span class="line">				reg = &lt;0x0209c000 0x4000&gt;;</span><br><span class="line">				interrupts = &lt;GIC_SPI 66 IRQ_TYPE_LEVEL_HIGH&gt;,</span><br><span class="line">					     &lt;GIC_SPI 67 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">				gpio-controller;</span><br><span class="line">				#gpio-cells = &lt;2&gt;;     //用2个cell描述gpio引脚</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				#interrupt-cells = &lt;2&gt;;</span><br><span class="line">			&#125;;</span><br></pre></td></tr></table></figure>



<h1 id="10-应用程序和驱动程序的更多交互方式"><a href="#10-应用程序和驱动程序的更多交互方式" class="headerlink" title="10 应用程序和驱动程序的更多交互方式"></a>10 应用程序和驱动程序的更多交互方式</h1><h2 id="1-APP读取按键值的四种方式"><a href="#1-APP读取按键值的四种方式" class="headerlink" title="1 APP读取按键值的四种方式"></a>1 APP读取按键值的四种方式</h2><ul>
<li><strong>查询方式</strong></li>
<li><strong>休眠-唤醒方式</strong></li>
<li>poll <strong>方式</strong> </li>
<li><strong>异步通知方式</strong></li>
</ul>
<h2 id="2-中断系统的设备树分析"><a href="#2-中断系统的设备树分析" class="headerlink" title="2 中断系统的设备树分析"></a>2 中断系统的设备树分析</h2><blockquote>
<p>中断流程：在ARM架构里面详细分析过中断的流程</p>
</blockquote>
<p>linux源码根目录&#x2F;arch&#x2F;arm&#x2F;boot&#x2F;dts&#x2F;imx6ull.dtsi</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">intc: interrupt-controller@00a01000 &#123;</span><br><span class="line">		compatible = &quot;arm,cortex-a7-gic&quot;;</span><br><span class="line">		#interrupt-cells = &lt;3&gt;;         	 /* &lt;类别 中断号 触发方式&gt; */</span><br><span class="line">		interrupt-controller;</span><br><span class="line">		reg = &lt;0x00a01000 0x1000&gt;,</span><br><span class="line">		      &lt;0x00a02000 0x100&gt;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gpc: gpc@020dc000 &#123;</span><br><span class="line">				compatible = &quot;fsl,imx6ul-gpc&quot;, &quot;fsl,imx6q-gpc&quot;;</span><br><span class="line">				reg = &lt;0x020dc000 0x4000&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				#interrupt-cells = &lt;3&gt;;</span><br><span class="line">				interrupts = &lt;GIC_SPI 89 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">				interrupt-parent = &lt;&amp;intc&gt;;								/* 继承intc */</span><br><span class="line">				fsl,mf-mix-wakeup-irq = &lt;0xfc00000 0x7d00 0x0 0x1400640&gt;;</span><br><span class="line">			&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">soc &#123;</span><br><span class="line">		#address-cells = &lt;1&gt;;</span><br><span class="line">		#size-cells = &lt;1&gt;;</span><br><span class="line">		compatible = &quot;simple-bus&quot;;</span><br><span class="line">		interrupt-parent = &lt;&amp;gpc&gt;;										/* 继承gpc */</span><br><span class="line">		ranges;</span><br><span class="line">		</span><br><span class="line">		........</span><br><span class="line">		</span><br><span class="line">		gpio1: gpio@0209c000 &#123;</span><br><span class="line">				compatible = &quot;fsl,imx6ul-gpio&quot;, &quot;fsl,imx35-gpio&quot;;</span><br><span class="line">				reg = &lt;0x0209c000 0x4000&gt;;</span><br><span class="line">				interrupts = &lt;GIC_SPI 66 IRQ_TYPE_LEVEL_HIGH&gt;,</span><br><span class="line">					     &lt;GIC_SPI 67 IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">				gpio-controller;</span><br><span class="line">				#gpio-cells = &lt;2&gt;;</span><br><span class="line">				interrupt-controller;</span><br><span class="line">				#interrupt-cells = &lt;2&gt;;</span><br><span class="line">			&#125;;</span><br><span class="line">		.............</span><br><span class="line">		gpio5:.......</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h1 id="11-用一个程序总结驱动机制"><a href="#11-用一个程序总结驱动机制" class="headerlink" title="11 用一个程序总结驱动机制"></a>11 用一个程序总结驱动机制</h1><h1 id="12-驱动开发基础"><a href="#12-驱动开发基础" class="headerlink" title="12 驱动开发基础"></a>12 驱动开发基础</h1><ul>
<li>非阻塞方式：NOBLOCK，不等待，直接返回</li>
<li>休眠唤醒：中断</li>
<li>poll机制：有一个timeout，在指定的时间内检测有没有数据</li>
<li>异步通知机制：信号<ul>
<li>信号处理内部机制：实际上就是修改栈中LR的值，从而跳去执行信号处理函数，执行完后，触发异常，异常处理，恢复之前的LR</li>
</ul>
</li>
</ul>
<blockquote>
<p>推荐书：《linux源代码情景分析》，毛德操</p>
</blockquote>
<h1 id="13-实战-SR501人体红外模块驱动开发"><a href="#13-实战-SR501人体红外模块驱动开发" class="headerlink" title="13 实战_SR501人体红外模块驱动开发"></a>13 实战_SR501人体红外模块驱动开发</h1><h2 id="驱动编写方法"><a href="#驱动编写方法" class="headerlink" title="驱动编写方法"></a>驱动编写方法</h2><ul>
<li>中断</li>
<li>内核线程</li>
</ul>
<h2 id="1原理图"><a href="#1原理图" class="headerlink" title="1原理图"></a>1原理图</h2><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231124155738845.png" alt="image-20231124155738845"></p>
<p>人体都有恒定的体温，一般在37度，所以会发出特定波长10uM左右的红外线，被动式红外探头就是靠探测人体发射的10uM左右的红外线而进行工作的。人体发射的10uM左右的红外线通过菲泥尔滤光片增强后聚集到红外感应源上。红外感应源通常采用热释电元件，这种元件在接收到人体红外辐射温度发生变化时就会失去电荷平衡，向外释放电荷，后续电路经检测处理后就能产生报警信号。</p>
<p>人体红外模块是一种能够检测人或动物发射的红外线而输出电信号的传感器。广泛应用于各种自动化控制装置中。比如常见的楼道自动开关、防盗报警等。如果有人在量程内运动，DO引脚将会输出有效信号。</p>
<p>实物和使用方法如下图所示，可以设置探测距离、延迟控制等：</p>
<p>通过跳线来设置是否可以重复触发，默认为L。其中L表示不可重复，H表示可重复。含义如下：</p>
<p>① 不可重复触发方式：</p>
<p>感应到人体并输出高电平后，延时时间一结束，输出将自动从高电平变为低电平。</p>
<p>② 重复触发方式： </p>
<p>感应到人体后输出高电平后，在延时时间段内，如果有人体在其感应范围内活动，其输出将一直保持高电平，直到人离开后才延时将高电平变为低电平(感应模块检测到人体的每一次活动后会自动顺延一个延时时间段，并且以最后一次活动的时间为延时时间的起始点)。</p>
<p>可以通过电位器实现封锁时间和检测距离的调节：</p>
<p>① 调节检测距离：</p>
<p>即有效距离的远近。调节距离电位器顺时针旋转，感应距离增大（约 7 米）；反之，感应距离减小（约 3 米）。</p>
<p>② 封锁时间：</p>
<p>感应模块在每一次感应输出后(高电平变为低电平)，可以紧跟着设置一个封锁时间，在此时间段内感应器不接收任何感应信号。</p>
<p>此功能可以实现(感应输出时间和封锁时间)两者的间隔工作，可应用于间隔探测产品；同时此功能可有效抑制负载切换过程中产生的各种干扰。</p>
<p>调节延时电位器顺时针旋转，感应延时加长（约300S），反之，感应延时减短（约0.5S）。</p>
<h2 id="2-实现设备树节点"><a href="#2-实现设备树节点" class="headerlink" title="2 实现设备树节点"></a>2 实现设备树节点</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sr501 &#123;</span><br><span class="line">		compatible = &quot;alpha-sr501&quot;;</span><br><span class="line">		gpios = &lt;&amp;gpio4 19 GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3-驱动框架"><a href="#3-驱动框架" class="headerlink" title="3 驱动框架"></a>3 驱动框架</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/interrupt.h&gt;</span><br><span class="line">#include &lt;linux/irq.h&gt;</span><br><span class="line">#include &lt;linux/sched.h&gt;</span><br><span class="line">#include &lt;linux/pm.h&gt;</span><br><span class="line">#include &lt;linux/slab.h&gt;</span><br><span class="line">#include &lt;linux/sysctl.h&gt;</span><br><span class="line">#include &lt;linux/proc_fs.h&gt;</span><br><span class="line">#include &lt;linux/delay.h&gt;</span><br><span class="line">#include &lt;linux/platform_device.h&gt;</span><br><span class="line">#include &lt;linux/input.h&gt;</span><br><span class="line">#include &lt;linux/gpio_keys.h&gt;</span><br><span class="line">#include &lt;linux/workqueue.h&gt;</span><br><span class="line">#include &lt;linux/gpio.h&gt;</span><br><span class="line">#include &lt;linux/of.h&gt;</span><br><span class="line">#include &lt;linux/of_platform.h&gt;</span><br><span class="line">#include &lt;linux/of_gpio.h&gt;</span><br><span class="line">#include &lt;linux/of_irq.h&gt;</span><br><span class="line">#include &lt;linux/spinlock.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static int sr501_open(struct inode *inode, struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 从设备读数据 */</span><br><span class="line">/* 设备文件 返回给用户空间的数据缓冲区 读取长度 相对于文件首地址的偏移 */</span><br><span class="line">static ssize_t sr501_read(struct file *filp, char __user *buf, </span><br><span class="line">                           size_t cnt,        loff_t *offt)</span><br><span class="line">&#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 向设备写数据 */</span><br><span class="line">/* 设备文件 要写给设备写入的数据 写入长度 相对于文件首地址的偏移 */</span><br><span class="line">static ssize_t sr501_write(struct file *filp, const char __user *buf, size_t cnt, loff_t *offt)</span><br><span class="line">&#123;</span><br><span class="line">        </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static unsigned int sr501_poll(struct file *filp, struct poll_table_struct *wait)</span><br><span class="line">&#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 关闭设备 */</span><br><span class="line">static int sr501_release(struct inode *inode, struct file *filp)</span><br><span class="line">&#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static const struct file_operations sr501_fops = &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = sr501_open,</span><br><span class="line">	.read = sr501_read,</span><br><span class="line">	.write = sr501_write,</span><br><span class="line">	.poll = sr501_poll,</span><br><span class="line">	.release = sr501_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static int sr501_probe(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">    printk(&quot;sr501 match sucess!\r\n&quot;);</span><br><span class="line">    register_chrdev(0, &quot;sr501&quot;, &amp;sr501_fops);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int sr501_remove(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">    unregister_chrdev(0, &quot;sr501&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static const struct of_device_id sr501_of_match[] = &#123;</span><br><span class="line">	&#123; .compatible = &quot;alpha-sr501&quot;, &#125;,</span><br><span class="line">	&#123; &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct platform_driver sr501_device_driver = &#123;</span><br><span class="line">	.probe		= sr501_probe,</span><br><span class="line">	.remove		= sr501_remove,</span><br><span class="line">	.driver		= &#123;</span><br><span class="line">		.name	= &quot;sr501&quot;,</span><br><span class="line">		.of_match_table = of_match_ptr(sr501_of_match),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int __init sr501_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    printk(&quot;%s %s line %d\r\n&quot;,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line">	return platform_driver_register(&amp;sr501_device_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void __exit sr501_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	platform_driver_unregister(&amp;sr501_device_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(sr501_init);</span><br><span class="line">module_exit(sr501_exit);</span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="4-测试"><a href="#4-测试" class="headerlink" title="4 测试"></a>4 测试</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make dtbs</span><br><span class="line">sudo cp arch/arm/boot/dts/imx6ull-alpha.dtb /home/lk/linux/tftpboot/ -rf</span><br><span class="line">sudo cp sr501.ko  /home/lk/linux/nfs/rootfs/lib/modules/4.1.15/ -rf</span><br></pre></td></tr></table></figure>



<h2 id="5-查看中断"><a href="#5-查看中断" class="headerlink" title="5 查看中断"></a>5 查看中断</h2><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231124214601939.png" alt="image-20231124214601939"></p>
<h1 id="17-实战-SR04超声波测距模块驱动开发"><a href="#17-实战-SR04超声波测距模块驱动开发" class="headerlink" title="17 实战_SR04超声波测距模块驱动开发"></a>17 实战_SR04超声波测距模块驱动开发</h1><h2 id="驱动编写方法-1"><a href="#驱动编写方法-1" class="headerlink" title="驱动编写方法"></a>驱动编写方法</h2><ul>
<li>查询方式</li>
<li>中断</li>
</ul>
<h2 id="1-SR04工作原理"><a href="#1-SR04工作原理" class="headerlink" title="1 SR04工作原理"></a>1 SR04工作原理</h2><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/01_sr04_sch.png" alt="image-20211223183302503"></p>
<p>要测距，需如下操作：</p>
<ul>
<li><p>触发：向Trig（脉冲触发引脚）发出一个大约10us的高电平。</p>
<ul>
<li>模块就自动发出8个40Khz的超声波，超声波遇到障碍物后反射回来，模块收到返回来的超声波。</li>
</ul>
</li>
<li><p>回响：模块接收到反射回来的超声波后，Echo引脚输出一个与检测距离成比例的高电平。</p>
</li>
<li><p>我们只要计算Echo引脚维持高电平的时间T即刻计算举例：D &#x3D; 340*T&#x2F;2。</p>
</li>
</ul>
<h2 id="2-原理图"><a href="#2-原理图" class="headerlink" title="2 原理图"></a>2 原理图</h2><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231125155404835.png" alt="image-20231125155404835"></p>
<h2 id="3-方法1-轮询方式"><a href="#3-方法1-轮询方式" class="headerlink" title="3 方法1   轮询方式"></a>3 方法1   轮询方式</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int us = 0;</span><br><span class="line"></span><br><span class="line">local_irq_save(flags);    // 关中断</span><br><span class="line"></span><br><span class="line">//使用udelay来延时判断引脚电平</span><br><span class="line">while (低电平); // 等待高电平</span><br><span class="line">while (高电平)&#123; udelay(1); us++; &#125;  // 累加时间</span><br><span class="line"></span><br><span class="line">local_irq_restore(flags); // 恢复中断</span><br></pre></td></tr></table></figure>



<h2 id="4-方法2中断"><a href="#4-方法2中断" class="headerlink" title="4 方法2	中断"></a>4 方法2	中断</h2><p>设置Echo中断为双边沿触发，在上升沿读取时间T1，在下降沿读取时间T2：T2-T1就是高电平的时间。</p>
<p>关键在于：使用什么函数读取时间？</p>
<p>内核在启动时，定时器便开始计数，通过获取计数，可计算得出运行时间。</p>
<p>获取时间函数如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ktime_get_ns();          // 获取内核启动到现在的时间，在挂起时会暂停</span><br><span class="line">ktime_get_boottime_ns(); // 获取内核启动到现在的时间，不受挂起影响，是绝对时间</span><br><span class="line">ktime_get_real_ns();     // 获取Unix时间(1970年)到现在的时间，可能涉及闰秒更新，用得比较少</span><br><span class="line">ktime_get_raw_ns();      // 类似ktime_get_ns(),不涉及闰秒更新，用得比较少</span><br></pre></td></tr></table></figure>



<h2 id="5-实现设备树节点"><a href="#5-实现设备树节点" class="headerlink" title="5 实现设备树节点"></a>5 实现设备树节点</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sr04 &#123;</span><br><span class="line">		compatible = &quot;alpha-sr04&quot;;</span><br><span class="line">		trig-gpios = &lt;&amp;gpio1 1 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		echo-gpios = &lt;&amp;gpio1 2 GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="6-源码"><a href="#6-源码" class="headerlink" title="6 源码"></a>6 源码</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/poll.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/errno.h&gt;</span><br><span class="line">#include &lt;linux/miscdevice.h&gt;</span><br><span class="line">#include &lt;linux/kernel.h&gt;</span><br><span class="line">#include &lt;linux/major.h&gt;</span><br><span class="line">#include &lt;linux/mutex.h&gt;</span><br><span class="line">#include &lt;linux/proc_fs.h&gt;</span><br><span class="line">#include &lt;linux/seq_file.h&gt;</span><br><span class="line">#include &lt;linux/stat.h&gt;</span><br><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/device.h&gt;</span><br><span class="line">#include &lt;linux/tty.h&gt;</span><br><span class="line">#include &lt;linux/kmod.h&gt;</span><br><span class="line">#include &lt;linux/gfp.h&gt;</span><br><span class="line">#include &lt;linux/gpio/consumer.h&gt;</span><br><span class="line">#include &lt;linux/platform_device.h&gt;</span><br><span class="line">#include &lt;linux/of_gpio.h&gt;</span><br><span class="line">#include &lt;linux/of_irq.h&gt;</span><br><span class="line">#include &lt;linux/interrupt.h&gt;</span><br><span class="line">#include &lt;linux/irq.h&gt;</span><br><span class="line">#include &lt;linux/slab.h&gt;</span><br><span class="line">#include &lt;linux/fcntl.h&gt;</span><br><span class="line">#include &lt;linux/timer.h&gt;</span><br><span class="line">#include &lt;linux/workqueue.h&gt;</span><br><span class="line">#include &lt;asm/current.h&gt;</span><br><span class="line">#include &lt;linux/delay.h&gt;</span><br><span class="line">#include &lt;linux/drbd.h&gt;</span><br><span class="line"></span><br><span class="line">static int major;</span><br><span class="line">static struct class *sr04_class;</span><br><span class="line">static struct gpio_desc *sr04_trig;</span><br><span class="line">static struct gpio_desc *sr04_echo;</span><br><span class="line">static int irq;</span><br><span class="line">static wait_queue_head_t sr04_wq;</span><br><span class="line">static u64 sr04_data_ns = 0;  </span><br><span class="line"></span><br><span class="line">/* 实现对应的open/read/write等函数，填入file_operations结构体                   */</span><br><span class="line">static ssize_t sr04_drv_read (struct file *file, char __user *buf, size_t size, loff_t *offset)</span><br><span class="line">&#123;</span><br><span class="line">#if 0</span><br><span class="line">	int us = 0;</span><br><span class="line">	unsigned long flags;</span><br><span class="line">	int timeout_us = 1000000;</span><br><span class="line">	</span><br><span class="line">	local_irq_save(flags);	  // 关中断</span><br><span class="line"></span><br><span class="line">	/* 发送10us高电平    , 测量距离 2cm-450cm */</span><br><span class="line">	gpiod_set_value(sr04_trig, 1);</span><br><span class="line">	udelay(15);</span><br><span class="line">	gpiod_set_value(sr04_trig, 0);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	//使用udelay来延时判断引脚电平</span><br><span class="line">	while (!gpiod_get_value(sr04_echo) &amp;&amp; timeout_us)</span><br><span class="line">	&#123;</span><br><span class="line">		udelay(1); // 等待高电平</span><br><span class="line">		timeout_us--;</span><br><span class="line">	&#125;</span><br><span class="line">	if (!timeout_us)</span><br><span class="line">	&#123;</span><br><span class="line">		local_irq_restore(flags); // 恢复中断</span><br><span class="line">		return -EAGAIN;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	timeout_us = 1000000;</span><br><span class="line">	while (gpiod_get_value(sr04_echo) &amp;&amp; timeout_us)</span><br><span class="line">	&#123; </span><br><span class="line">		udelay(1); </span><br><span class="line">		us++; // 累加时间</span><br><span class="line">		timeout_us--;</span><br><span class="line">	&#125;  </span><br><span class="line"></span><br><span class="line">	if (!timeout_us)</span><br><span class="line">	&#123;</span><br><span class="line">		local_irq_restore(flags); // 恢复中断</span><br><span class="line">		return -EAGAIN;</span><br><span class="line">	&#125;</span><br><span class="line">		</span><br><span class="line">	local_irq_restore(flags); // 恢复中断</span><br><span class="line">	copy_to_user(buf, &amp;us, 4);</span><br><span class="line">	return 4;</span><br><span class="line">#else</span><br><span class="line">   int timeout;</span><br><span class="line">	</span><br><span class="line">	/* 发送10us高电平    , 测量距离 2cm-450cm */</span><br><span class="line">	gpiod_set_value(sr04_trig, 1);</span><br><span class="line">	udelay(15);</span><br><span class="line">	gpiod_set_value(sr04_trig, 0);</span><br><span class="line"></span><br><span class="line">	/* 等待数据 */</span><br><span class="line">	timeout = wait_event_interruptible_timeout(sr04_wq, sr04_data_ns, HZ);	</span><br><span class="line">	if (timeout)</span><br><span class="line">	&#123;</span><br><span class="line">		copy_to_user(buf, &amp;sr04_data_ns, 4);</span><br><span class="line">		sr04_data_ns = 0;</span><br><span class="line">		return 4;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		return -EAGAIN;</span><br><span class="line">	&#125; </span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static unsigned int sr04_drv_poll(struct file *fp, poll_table * wait)</span><br><span class="line">&#123;</span><br><span class="line">//	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">//	poll_wait(fp, &amp;sr04_wait, wait);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 定义自己的file_operations结构体                                              */</span><br><span class="line">static struct file_operations sr04_fops = &#123;</span><br><span class="line">	.owner	 = THIS_MODULE,</span><br><span class="line">	.read    = sr04_drv_read,</span><br><span class="line">	.poll    = sr04_drv_poll,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static irqreturn_t sr04_isr(int irq, void *dev_id)</span><br><span class="line">&#123;</span><br><span class="line">	int val = gpiod_get_value(sr04_echo);</span><br><span class="line"></span><br><span class="line">	if (val) /* 上升沿 */</span><br><span class="line">	&#123;</span><br><span class="line">		/* 1. 记录数据 */</span><br><span class="line">		sr04_data_ns = ktime_get_ns();</span><br><span class="line">		//printk(&quot;%s %s %d, val = 0x%x\n&quot;, __FILE__, __FUNCTION__, __LINE__, sr04_data);</span><br><span class="line">	&#125;</span><br><span class="line">	else /* 下降沿 */</span><br><span class="line">	&#123;</span><br><span class="line">		sr04_data_ns = ktime_get_ns() - sr04_data_ns;</span><br><span class="line">		/* 2. 唤醒APP:去同一个链表把APP唤醒 */</span><br><span class="line">		wake_up(&amp;sr04_wq);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	return IRQ_HANDLED; // IRQ_WAKE_THREAD;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 1. 从platform_device获得GPIO</span><br><span class="line"> * 2. gpio=&gt;irq</span><br><span class="line"> * 3. request_irq</span><br><span class="line"> */</span><br><span class="line">static int sr04_probe(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">	/* 1. 获得硬件信息 */</span><br><span class="line">	sr04_trig = gpiod_get(&amp;pdev-&gt;dev, &quot;trig&quot;, GPIOD_OUT_LOW);</span><br><span class="line">	sr04_echo = gpiod_get(&amp;pdev-&gt;dev, &quot;echo&quot;, GPIOD_IN);</span><br><span class="line"></span><br><span class="line">	irq = gpiod_to_irq(sr04_echo);</span><br><span class="line">    printk(&quot;irq: %d\r\n&quot;,irq);</span><br><span class="line">	request_irq(irq, sr04_isr, IRQF_TRIGGER_RISING|IRQF_TRIGGER_FALLING, &quot;sr04&quot;, NULL);</span><br><span class="line"></span><br><span class="line">	/* 2. device_create */</span><br><span class="line">	device_create(sr04_class, NULL, MKDEV(major, 0), NULL, &quot;sr04&quot;);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int sr04_remove(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">	device_destroy(sr04_class, MKDEV(major, 0));</span><br><span class="line">	free_irq(irq, NULL);</span><br><span class="line">	gpiod_put(sr04_trig);</span><br><span class="line">	gpiod_put(sr04_echo);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static const struct of_device_id ask100_sr04[] = &#123;</span><br><span class="line">    &#123; .compatible = &quot;alpha-sr04&quot; &#125;,</span><br><span class="line">    &#123; &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/* 1. 定义platform_driver */</span><br><span class="line">static struct platform_driver sr04s_driver = &#123;</span><br><span class="line">    .probe      = sr04_probe,</span><br><span class="line">    .remove     = sr04_remove,</span><br><span class="line">    .driver     = &#123;</span><br><span class="line">        .name   = &quot;alpha-sr04&quot;,</span><br><span class="line">        .of_match_table = ask100_sr04,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/* 2. 在入口函数注册platform_driver */</span><br><span class="line">static int __init sr04_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    int err;</span><br><span class="line">    </span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">	/* 注册file_operations 	*/</span><br><span class="line">	major = register_chrdev(0, &quot;sr04&quot;, &amp;sr04_fops);  </span><br><span class="line"></span><br><span class="line">	sr04_class = class_create(THIS_MODULE, &quot;sr04_class&quot;);</span><br><span class="line">	if (IS_ERR(sr04_class)) &#123;</span><br><span class="line">		printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">		unregister_chrdev(major, &quot;sr04&quot;);</span><br><span class="line">		return PTR_ERR(sr04_class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	init_waitqueue_head(&amp;sr04_wq);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">    err = platform_driver_register(&amp;sr04s_driver); </span><br><span class="line">	</span><br><span class="line">	return err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 3. 有入口函数就应该有出口函数：卸载驱动程序时，就会去调用这个出口函数</span><br><span class="line"> *     卸载platform_driver</span><br><span class="line"> */</span><br><span class="line">static void __exit sr04_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">    platform_driver_unregister(&amp;sr04s_driver);</span><br><span class="line">	class_destroy(sr04_class);</span><br><span class="line">	unregister_chrdev(major, &quot;sr04&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 7. 其他完善：提供设备信息，自动创建设备节点                                     */</span><br><span class="line"></span><br><span class="line">module_init(sr04_init);</span><br><span class="line">module_exit(sr04_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br></pre></td></tr></table></figure>

<h1 id="18-实战-DHT11温湿度传感器驱动开发"><a href="#18-实战-DHT11温湿度传感器驱动开发" class="headerlink" title="18 实战_DHT11温湿度传感器驱动开发"></a>18 实战_DHT11温湿度传感器驱动开发</h1><h2 id="驱动编写方法-2"><a href="#驱动编写方法-2" class="headerlink" title="驱动编写方法"></a>驱动编写方法</h2><ul>
<li>查询方式</li>
<li>中断</li>
<li>IIO子系统</li>
</ul>
<h2 id="1-DHT11工作原理"><a href="#1-DHT11工作原理" class="headerlink" title="1. DHT11工作原理"></a>1. DHT11工作原理</h2><h3 id="1-1-硬件信号"><a href="#1-1-硬件信号" class="headerlink" title="1.1 硬件信号"></a>1.1 硬件信号</h3><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/01_sch.png" alt="image-20211225161948946"></p>
<p>需要先发一个开始信号给DHT11，才能接收数据。</p>
<p>下图为一次完整的传输示例，其中深黑色信号表示由主机驱动，即主机向DHT11发信号，浅灰色信号表示DHT11驱动，即DHT11发向主机发信号。</p>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/02_operaions.png"></p>
<p>当主机没有与DHT11通信时，总线处于空闲状态，此时总线电平由于上拉电阻的作用处于高电平。</p>
<p>当主机与DHT11正在通信时，总线处于通信状态，一次完整的通信过程如下：</p>
<ul>
<li><p>主机将对应的GPIO管脚配置为输出，准备向DHT11发送数据；</p>
</li>
<li><p>主机发送一个开始信号：</p>
<ul>
<li>开始信号 &#x3D; 一个低脉冲 + 一个高脉冲。低脉冲至少持续18ms，高脉冲持续20-40us。</li>
</ul>
</li>
<li><p>主机将对应的GPIO管脚配置为输入，准备接受DHT11传来的数据，这时信号由上拉电阻拉高；</p>
</li>
<li><p>DHT11发出响应信号：</p>
<ul>
<li>响应信号 &#x3D; 一个低脉冲 + 一个高脉冲。低脉冲持续80us，高脉冲持续80us。</li>
</ul>
</li>
<li><p>DHT11发出数据信号：</p>
<ul>
<li>数据为0的一位信号 &#x3D; 一个低脉冲 + 一个高脉冲。低脉冲持续50us，高脉冲持续26～28us。</li>
<li>数据为1的一位信号 &#x3D; 一个低脉冲 + 一个高脉冲。低脉冲持续50us，高脉冲持续70us。</li>
</ul>
</li>
<li><p>DHT11发出结束信号：</p>
<ul>
<li>最后1bit数据传送完毕后，DHT11拉低总线50us，然后释放总线，总线由上拉电阻拉高进入空闲状态。</li>
</ul>
</li>
</ul>
<p>​                               </p>
<h3 id="1-2-数据格式"><a href="#1-2-数据格式" class="headerlink" title="1.2 数据格式"></a>1.2 数据格式</h3><p>数据格式: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">8bit湿度整数数据+8bit湿度小数数据</span><br><span class="line">+8bi温度整数数据+8bit温度小数数据</span><br><span class="line">+8bit校验和</span><br></pre></td></tr></table></figure>

<p>数据传送正确时,校验和等于“8bit湿度整数数据+8bit湿度小数数据+8bi温度整数数据+8bit温度小数数据”所得结果的末8位。</p>
<h2 id="2-编程思路"><a href="#2-编程思路" class="headerlink" title="2. 编程思路"></a>2. 编程思路</h2><p>有了上述基础知识后就可以开始编写程序了。</p>
<p>编程思路如下：</p>
<ul>
<li>设置好GPIO；</li>
<li>主机把GPIO设置为输出引脚，发送开始信号，然后把GPIO设置为输入引脚；</li>
<li>主机判断是否收到DHT11的回应信号；</li>
<li>接收到回应信号后，开始读取数据；</li>
<li>接收完数据后，校验、解析。</li>
</ul>
<p>关键在于如何得到一位数据，看看下图：</p>
<ul>
<li>先等待低电平结束，一直等到出现高电平；然后延时40us，读取GPIO值：这就是该位的数据值。</li>
</ul>
<p> <img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/03_dht11_time.png"></p>
<h2 id="3-编写驱动程序"><a href="#3-编写驱动程序" class="headerlink" title="3. 编写驱动程序"></a>3. 编写驱动程序</h2><h3 id="3-1-方法1-查询方式"><a href="#3-1-方法1-查询方式" class="headerlink" title="3.1 方法1: 查询方式"></a>3.1 方法1: 查询方式</h3><p>触发DHT11转换数据后，就把引脚配置为输入引脚，检测引脚的电平变化，并记录高低电平的时间，最后解析出温湿度。</p>
<p><strong>注意</strong>：要关闭中断。</p>
<p>示例代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">dht11_read_byte</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//使用udelay来延时判断引脚电平</span></span><br><span class="line">    <span class="keyword">while</span> (低电平); <span class="comment">// 等待高电平</span></span><br><span class="line">    <span class="keyword">while</span> (高电平)&#123; udelay(<span class="number">1</span>); us++; &#125;  <span class="comment">// 累加时间</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> us = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">local_irq_save(flags);    <span class="comment">// 关中断</span></span><br><span class="line">val1 = dht11_read_byte();</span><br><span class="line">val2 = dht11_read_byte();</span><br><span class="line">tmp1 = dht11_read_byte();</span><br><span class="line">tmp2 = dht11_read_byte();</span><br><span class="line">crc  = dht11_read_byte();</span><br><span class="line">local_irq_restore(flags); <span class="comment">// 恢复中断</span></span><br></pre></td></tr></table></figure>




<h3 id="3-2-方法2-中断方式"><a href="#3-2-方法2-中断方式" class="headerlink" title="3.2 方法2: 中断方式"></a>3.2 方法2: 中断方式</h3><p>触发DHT11转换数据后，就把引脚配置为输入引脚，并注册中断：在中断函数中记录上升沿、下降沿的实际，解析出温湿度。</p>
<p>获取时间函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ktime_get_ns();          <span class="comment">// 获取内核启动到现在的时间，在挂起时会暂停</span></span><br><span class="line">ktime_get_boottime_ns(); <span class="comment">// 获取内核启动到现在的时间，不受挂起影响，是绝对时间</span></span><br><span class="line">ktime_get_real_ns();     <span class="comment">// 获取Unix时间(1970年)到现在的时间，可能涉及闰秒更新，用得比较少</span></span><br><span class="line">ktime_get_raw_ns();      <span class="comment">// 类似ktime_get_ns(),不涉及闰秒更新，用得比较少</span></span><br></pre></td></tr></table></figure>



<h3 id="3-3-方法3-使用IIO子系统"><a href="#3-3-方法3-使用IIO子系统" class="headerlink" title="3.3 方法3: 使用IIO子系统"></a>3.3 方法3: 使用IIO子系统</h3><p>内核已经自带DHT11的驱动程序：<code>drivers/iio/humidity/dht11.c</code>：</p>
<ul>
<li><p>配置内核<br><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/04_config_dht11_kernel.png" alt="image-20211225162846563"></p>
</li>
<li><p>编写设备树，参考<code>Documentation\devicetree\bindings\iio\humidity\dht11.txt</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// imx6ull</span><br><span class="line">humidity_sensor &#123; compatible = &quot;dht11&quot;;</span><br><span class="line">	gpios = &lt;&amp;gpio4 19 0&gt;; </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// stm32mp157</span><br><span class="line">humidity_sensor &#123; compatible = &quot;dht11&quot;;</span><br><span class="line">	gpios = &lt;&amp;gpioa 50&gt;; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>怎么使用？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/bus/iio/devices/iio:device1/in_temp_input</span><br><span class="line">cat /sys/bus/iio/devices/iio:device1/in_humidityrelative_input</span><br></pre></td></tr></table></figure>

<h1 id="21-实战-DS18B20驱动编程"><a href="#21-实战-DS18B20驱动编程" class="headerlink" title="21 实战_DS18B20驱动编程"></a>21 实战_DS18B20驱动编程</h1><h2 id="1-硬件连接"><a href="#1-硬件连接" class="headerlink" title="1.  硬件连接"></a>1.  硬件连接</h2><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/01_sch-1701156562752.png" alt="image-20220104184716599"></p>
<h2 id="2-访问流程"><a href="#2-访问流程" class="headerlink" title="2. 访问流程"></a>2. 访问流程</h2><p>在一条数据线上，可以连接多个DS18B20。每个DS18B20都内嵌不同的ID，所以需要先选择某个DS18B20。</p>
<p>如果只有一个DS18B20，就不需要选择。</p>
<p>访问DS18B20的流程为：启动温度转换、读取温度。</p>
<p>怎么启动温度转换？方法如下：</p>
<ul>
<li>发出Start信号</li>
<li>得到回应</li>
<li>发出8位的数据，用于选择某个DS18B20</li>
<li>发出温度转换命令</li>
<li>等待温度转换完毕</li>
</ul>
<p>温度转换完毕后，数据存在DS18B20内部的暂存器中。怎么读出数据？方法如下：</p>
<ul>
<li>发出Start信号</li>
<li>得到回应</li>
<li>发出8位的数据，用于选择某个DS18B20</li>
<li>发出读暂存器的命令</li>
<li>读温度低8位</li>
<li>读温度高8位</li>
</ul>
<h2 id="3-硬件信号"><a href="#3-硬件信号" class="headerlink" title="3. 硬件信号"></a>3. 硬件信号</h2><h3 id="3-1-Start和回应"><a href="#3-1-Start和回应" class="headerlink" title="3.1 Start和回应"></a>3.1 Start和回应</h3><p>深黑色线表示由主机驱动信号，浅灰色线表示由DS18B20驱动信号。</p>
<p>最开始时引脚是高电平，想要开始传输信号：</p>
<ul>
<li>必须要拉低至少480us，这是复位信号；</li>
<li>然后拉高释放总线，等待15~60us之后，</li>
<li>如果GPIO上连有DS18B20芯片，它会拉低60~240us：这就是回应</li>
</ul>
<p>如果主机在最后检查到60～240us的低脉冲回应信号，则表示DS18B20初始化成功。</p>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/02_start_and_ack.png" alt="image-20220104185739784"></p>
<h3 id="3-2-写一位数据"><a href="#3-2-写一位数据" class="headerlink" title="3.2 写一位数据"></a>3.2 写一位数据</h3><p>如果写0，拉低至少60us(写周期为60-120us)即可；</p>
<p>如果写1，先拉低至少1us，然后拉高，整个写周期至少为60us即可。</p>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/03_write_bit.png" alt="image-20220104185839041"></p>
<h3 id="3-3-读一位数据"><a href="#3-3-读一位数据" class="headerlink" title="3.3 读一位数据"></a>3.3 读一位数据</h3><p>主机先拉低至少1us，随后读取电平，如果为0，即读到的数据是0，如果为1，即可读到的数据是1。</p>
<p>整个过程必须在15us内完成，15us后引脚都会被拉高。</p>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/04_read_bit.png" alt="image-20220104190003488"></p>
<h2 id="4-DS18B20内部寄存器"><a href="#4-DS18B20内部寄存器" class="headerlink" title="4. DS18B20内部寄存器"></a>4. DS18B20内部寄存器</h2><p>参考：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">《嵌入式Linux应用开发完全手册V4.0_韦东山全系列视频文档-IMX6ULL开发板.docx》</span><br><span class="line">	第13篇 IMX6ULL裸机开发</span><br><span class="line">		第二十二章 DS18B20温度模块</span><br></pre></td></tr></table></figure>



<h2 id="5-编写驱动程序"><a href="#5-编写驱动程序" class="headerlink" title="5. 编写驱动程序"></a>5. 编写驱动程序</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line">#include &lt;linux/poll.h&gt;</span><br><span class="line"></span><br><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">#include &lt;linux/errno.h&gt;</span><br><span class="line">#include &lt;linux/miscdevice.h&gt;</span><br><span class="line">#include &lt;linux/kernel.h&gt;</span><br><span class="line">#include &lt;linux/major.h&gt;</span><br><span class="line">#include &lt;linux/mutex.h&gt;</span><br><span class="line">#include &lt;linux/proc_fs.h&gt;</span><br><span class="line">#include &lt;linux/seq_file.h&gt;</span><br><span class="line">#include &lt;linux/stat.h&gt;</span><br><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/device.h&gt;</span><br><span class="line">#include &lt;linux/tty.h&gt;</span><br><span class="line">#include &lt;linux/kmod.h&gt;</span><br><span class="line">#include &lt;linux/gfp.h&gt;</span><br><span class="line">#include &lt;linux/gpio/consumer.h&gt;</span><br><span class="line">#include &lt;linux/platform_device.h&gt;</span><br><span class="line">#include &lt;linux/of_gpio.h&gt;</span><br><span class="line">#include &lt;linux/of_irq.h&gt;</span><br><span class="line">#include &lt;linux/interrupt.h&gt;</span><br><span class="line">#include &lt;linux/irq.h&gt;</span><br><span class="line">#include &lt;linux/slab.h&gt;</span><br><span class="line">#include &lt;linux/fcntl.h&gt;</span><br><span class="line">#include &lt;linux/timer.h&gt;</span><br><span class="line">#include &lt;linux/workqueue.h&gt;</span><br><span class="line">#include &lt;asm/current.h&gt;</span><br><span class="line">#include &lt;linux/delay.h&gt;</span><br><span class="line">#include &lt;linux/drbd.h&gt;</span><br><span class="line">#include &lt;linux/ktime.h&gt;</span><br><span class="line">#include &lt;linux/version.h&gt;</span><br><span class="line"></span><br><span class="line">static int major;</span><br><span class="line">static struct class *ds18b20_class;</span><br><span class="line">static struct gpio_desc *ds18b20_data_pin;</span><br><span class="line"></span><br><span class="line">static void my_udelay(int us)</span><br><span class="line">&#123;</span><br><span class="line">	u64 pre,last;</span><br><span class="line">#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(5,0,0)</span><br><span class="line">	pre = ktime_get_boot_ns();</span><br><span class="line">	while(1)</span><br><span class="line">	&#123;</span><br><span class="line">		last = ktime_get_boot_ns();</span><br><span class="line">		if(last - pre &gt;= us*1000)</span><br><span class="line">			break;</span><br><span class="line">	&#125;</span><br><span class="line">#else</span><br><span class="line">	pre = ktime_get_boottime_ns();</span><br><span class="line">	while (1)</span><br><span class="line">	&#123;</span><br><span class="line">		last = ktime_get_boottime_ns();</span><br><span class="line">		if (last - pre &gt;= us * 1000)</span><br><span class="line">			break;</span><br><span class="line">	&#125;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int ds18b20_wait_for_ack(void)</span><br><span class="line">&#123;</span><br><span class="line">	int timeout_count = 500;</span><br><span class="line"></span><br><span class="line">	/* 如果是高电平,等待 */</span><br><span class="line">	while (gpiod_get_value(ds18b20_data_pin) &amp;&amp; --timeout_count)</span><br><span class="line">	&#123;</span><br><span class="line">		udelay(1);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (!timeout_count)</span><br><span class="line">		return -1;</span><br><span class="line"></span><br><span class="line">	/* 现在是低电平 */</span><br><span class="line">	timeout_count = 500;</span><br><span class="line">	while (!gpiod_get_value(ds18b20_data_pin) &amp;&amp; --timeout_count)</span><br><span class="line">	&#123;</span><br><span class="line">		udelay(1);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if (!timeout_count)</span><br><span class="line">		return -1;</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int ds18b20_reset(void)</span><br><span class="line">&#123;</span><br><span class="line">	/* 开始信号：主机驱动信号，发送480us低脉冲 */</span><br><span class="line">	gpiod_set_value(ds18b20_data_pin, 0);</span><br><span class="line">	my_udelay(480);</span><br><span class="line"></span><br><span class="line">	/* 等待应答 */</span><br><span class="line">	gpiod_direction_input(ds18b20_data_pin);</span><br><span class="line">	if (ds18b20_wait_for_ack())</span><br><span class="line">		return -1;</span><br><span class="line">	else</span><br><span class="line">		return 0;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void ds18b20_write_byte(unsigned char data)</span><br><span class="line">&#123;</span><br><span class="line">	int i;</span><br><span class="line">	for (i = 0; i &lt;8; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		if (data &amp; (1&lt;&lt;i))</span><br><span class="line">		&#123;</span><br><span class="line">			/* 输出1 */</span><br><span class="line">			gpiod_direction_output(ds18b20_data_pin, 0);</span><br><span class="line">			my_udelay(2);</span><br><span class="line">			</span><br><span class="line">			/* 设置为输入: 引脚默认为高 */</span><br><span class="line">			gpiod_direction_input(ds18b20_data_pin);</span><br><span class="line">			my_udelay(60);</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			/* 输出0 */</span><br><span class="line">			gpiod_direction_output(ds18b20_data_pin, 0);</span><br><span class="line">			my_udelay(60);</span><br><span class="line"></span><br><span class="line">			/* 设置为输入: 引脚默认为高 */</span><br><span class="line">			gpiod_direction_input(ds18b20_data_pin);</span><br><span class="line">			my_udelay(2);			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unsigned char ds18b20_read_byte(void)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned char data = 0;</span><br><span class="line">	int i;</span><br><span class="line"></span><br><span class="line">	for (i = 0; i &lt; 8; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		gpiod_direction_output(ds18b20_data_pin, 0);</span><br><span class="line">		my_udelay(2);</span><br><span class="line"></span><br><span class="line">		/* 设置为输入 */</span><br><span class="line">		gpiod_direction_input(ds18b20_data_pin);</span><br><span class="line"></span><br><span class="line">		/* 7us之后读引脚 */</span><br><span class="line">		my_udelay(7);</span><br><span class="line">		if (gpiod_get_value(ds18b20_data_pin))</span><br><span class="line">			data |= (1&lt;&lt;i);</span><br><span class="line"></span><br><span class="line">		/* 读到数据后, 等待足够60us */</span><br><span class="line">		my_udelay(60);				</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 实现对应的open/read/write等函数，填入file_operations结构体                   */</span><br><span class="line">static ssize_t ds18b20_drv_read (struct file *file, char __user *buf, size_t size, loff_t *offset)</span><br><span class="line">&#123;</span><br><span class="line">	unsigned long flags;</span><br><span class="line">	unsigned char tempL=0,tempH=0;</span><br><span class="line">	unsigned int integer;</span><br><span class="line">	unsigned char decimal1,decimal2,decimal;</span><br><span class="line">	int ret;</span><br><span class="line"></span><br><span class="line">	if (size != 5)</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	local_irq_save(flags);	  // 关中断</span><br><span class="line"></span><br><span class="line">	/* 访问DS18B20的流程为：启动温度转换、读取温度 */</span><br><span class="line"></span><br><span class="line">	/* 启动温度转换 */</span><br><span class="line">	/* 1.发送开始信号 */</span><br><span class="line">	/* 2.等待回应信号 */</span><br><span class="line">	if(ds18b20_reset())</span><br><span class="line">	&#123;</span><br><span class="line">		gpiod_direction_output(ds18b20_data_pin, 1);  /* 每次开始前都是高电平 */</span><br><span class="line">		local_irq_restore(flags); // 恢复中断</span><br><span class="line">		return -1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* 3.发出8位的数据，用于选择某个DS18B20 */</span><br><span class="line">	ds18b20_write_byte(0xcc); //忽略rom指令，直接使用功能指令</span><br><span class="line"></span><br><span class="line">	/* 4.发出温度转换命令 */</span><br><span class="line">	ds18b20_write_byte(0x44); //温度转换指令</span><br><span class="line"></span><br><span class="line">	/* 5.等待温度转换完毕 */</span><br><span class="line">	local_irq_restore(flags); // 恢复中断</span><br><span class="line">	//转换需要时间，延时1s</span><br><span class="line">	set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line">	schedule_timeout(HZ); </span><br><span class="line">	local_irq_save(flags);	  // 关中断</span><br><span class="line"></span><br><span class="line">	/* 不能省略！ */</span><br><span class="line">	gpiod_direction_output(ds18b20_data_pin, 1);	/* 每次开始前都是高电平 */</span><br><span class="line">	/* 读取温度 */</span><br><span class="line">	/* 1.发送开始信号 */</span><br><span class="line">	/* 2.等待回应信号 */</span><br><span class="line">	if(ds18b20_reset())</span><br><span class="line">	&#123;</span><br><span class="line">		gpiod_direction_output(ds18b20_data_pin, 1);	/* 每次开始前都是高电平 */</span><br><span class="line">		local_irq_restore(flags); // 恢复中断</span><br><span class="line">		return -1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* 3.发出8位的数据，用于选择某个DS18B20 */</span><br><span class="line">	ds18b20_write_byte(0xcc); //忽略rom指令，直接使用功能指令</span><br><span class="line"></span><br><span class="line">	/* 4.发出读暂存器的命令 */</span><br><span class="line">	ds18b20_write_byte(0xbe); //忽读暂存器指令</span><br><span class="line"></span><br><span class="line">	/* 5.读温度低8位，读温度高8位 */</span><br><span class="line">	tempL = ds18b20_read_byte(); //读温度低8位</span><br><span class="line">	tempH = ds18b20_read_byte(); //读温度高8位</span><br><span class="line"></span><br><span class="line">	/* 数据处理 */</span><br><span class="line">	if (tempH &gt; 0x7f)      							//最高位为1时温度是负</span><br><span class="line">	&#123;</span><br><span class="line">		tempL    = ~tempL;         				    //补码转换，取反加一</span><br><span class="line">		tempH    = ~tempH+1;      </span><br><span class="line">		integer  = tempL/16+tempH*16;      			//整数部分</span><br><span class="line">		decimal1 = (tempL&amp;0x0f)*10/16; 			//小数第一位</span><br><span class="line">		decimal2 = (tempL&amp;0x0f)*100/16%10;			//小数第二位</span><br><span class="line">		decimal  = decimal1*10+decimal2; 			//小数两位</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		integer  = tempL/16+tempH*16;      				//整数部分</span><br><span class="line">		decimal1 = (tempL&amp;0x0f)*10/16; 					//小数第一位</span><br><span class="line">		decimal2 = (tempL&amp;0x0f)*100/16%10;				//小数第二位</span><br><span class="line">		decimal  = decimal1*10+decimal2; 				//小数两位</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	local_irq_restore(flags); // 恢复中断</span><br><span class="line">	</span><br><span class="line">	gpiod_direction_output(ds18b20_data_pin, 1);	/* 每次开始前都是高电平 */</span><br><span class="line"></span><br><span class="line">	ret = copy_to_user(buf, &amp;integer, 4);</span><br><span class="line">	ret = copy_to_user(buf+4, &amp;decimal, 1);</span><br><span class="line"></span><br><span class="line">	return 5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 定义自己的file_operations结构体                                              */</span><br><span class="line">static struct file_operations ds18b20_fops = &#123;</span><br><span class="line">	.owner	 = THIS_MODULE,</span><br><span class="line">	.read    = ds18b20_drv_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 1. 从platform_device获得GPIO</span><br><span class="line"> * 2. gpio=&gt;irq</span><br><span class="line"> * 3. request_irq</span><br><span class="line"> */</span><br><span class="line">static int ds18b20_probe(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">	/* 1. 获得硬件信息 */</span><br><span class="line">	ds18b20_data_pin = gpiod_get(&amp;pdev-&gt;dev, NULL, GPIOD_OUT_LOW);</span><br><span class="line">	if (IS_ERR(ds18b20_data_pin))</span><br><span class="line">	&#123;</span><br><span class="line">		printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">		return PTR_ERR(ds18b20_data_pin);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* 2. 创建设备 */</span><br><span class="line">	device_create(ds18b20_class, NULL, MKDEV(major, 0), NULL, &quot;ds18b20&quot;);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static int ds18b20_remove(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">	device_destroy(ds18b20_class, MKDEV(major, 0));</span><br><span class="line">	gpiod_put(ds18b20_data_pin);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static const struct of_device_id ask100_ds18b20[] = &#123;</span><br><span class="line">    &#123; .compatible = &quot;alpha-ds18b20&quot; &#125;,</span><br><span class="line">    &#123; &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/* 1. 定义platform_driver */</span><br><span class="line">static struct platform_driver ds18b20s_driver = &#123;</span><br><span class="line">    .probe      = ds18b20_probe,</span><br><span class="line">    .remove     = ds18b20_remove,</span><br><span class="line">    .driver     = &#123;</span><br><span class="line">        .name   = &quot;alpha-ds18b20&quot;,</span><br><span class="line">        .of_match_table = ask100_ds18b20,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/* 2. 在入口函数注册platform_driver */</span><br><span class="line">static int __init ds18b20_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    int err;</span><br><span class="line">    </span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line"></span><br><span class="line">	/* 注册file_operations 	*/</span><br><span class="line">	major = register_chrdev(0, &quot;ds18b20&quot;, &amp;ds18b20_fops);  </span><br><span class="line"></span><br><span class="line">	ds18b20_class = class_create(THIS_MODULE, &quot;ds18b20_class&quot;);</span><br><span class="line">	if (IS_ERR(ds18b20_class)) &#123;</span><br><span class="line">		printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">		unregister_chrdev(major, &quot;ds18b20&quot;);</span><br><span class="line">		return PTR_ERR(ds18b20_class);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    err = platform_driver_register(&amp;ds18b20s_driver); </span><br><span class="line">	</span><br><span class="line">	return err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 3. 有入口函数就应该有出口函数：卸载驱动程序时，就会去调用这个出口函数</span><br><span class="line"> *     卸载platform_driver</span><br><span class="line"> */</span><br><span class="line">static void __exit ds18b20_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">	printk(&quot;%s %s line %d\n&quot;, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">    platform_driver_unregister(&amp;ds18b20s_driver);</span><br><span class="line">	class_destroy(ds18b20_class);</span><br><span class="line">	unregister_chrdev(major, &quot;ds18b20&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* 7. 其他完善：提供设备信息，自动创建设备节点                                     */</span><br><span class="line"></span><br><span class="line">module_init(ds18b20_init);</span><br><span class="line">module_exit(ds18b20_exit);</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="22-实战-红外遥控器HS0038的两种驱动程序"><a href="#22-实战-红外遥控器HS0038的两种驱动程序" class="headerlink" title="22 实战_红外遥控器HS0038的两种驱动程序"></a>22 实战_红外遥控器HS0038的两种驱动程序</h1><h2 id="1-硬件连接-1"><a href="#1-硬件连接-1" class="headerlink" title="1.  硬件连接"></a>1.  硬件连接</h2><p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/01_sch-1701229404264.png" alt="image-20220106190332522"></p>
<h2 id="2-通信协议"><a href="#2-通信协议" class="headerlink" title="2. 通信协议"></a>2. 通信协议</h2><p>我们按下遥控器按键的时候，遥控器自动发送某个红外信号，接收头接收到红外信号，然后把红外信号转换成电平信号，通过IRD这根线，传给SOC。整个传输，只涉及单向传输，由HS0038向主芯片传送。</p>
<p>因此，我们只需要编写程序，从IRD上获取数据即可，在这之前，我们需要先了解下数据是怎么表示的，也就是传输的红外数据的格式。</p>
<p>红外协议有：NEC、SONY、RC5、RC6等，常用的就是NEC格式，因此我们主要对NEC进行讲解。</p>
<p>在分析文章中的波形之前，我们先想象一下怎么在一条数据线上传输信号。</p>
<p>开始传输数据之前，一般都会发出一个start起始信号，通知对方我开始传输数据了，后面就是每一位每一位的数据。</p>
<p>NEC协议的开始是一段引导码：</p>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/02_data_seq.png"></p>
<p>这个引导码由一个9ms的低脉冲加上一个4.5ms的高脉冲组成，它用来通知接收方我要开始传输数据了。</p>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/03_pre_wave.png"></p>
<p>然后接着的是数据，数据由4字节组成：地址、地址(取反)、数据、数据(取反)，取反是用来校验用的。</p>
<p>地址是指遥控器的ID，每一类遥控器的ID都不一样，这样就可以防止操控电视的遥控器影响空调。数据就是遥控器上的不同按键值。</p>
<p>从前面的图可以知道，NEC每次要发32位（地址、地址取反、数据、数据取反，每个8位）的数据。数据的1和0，开始都是0.56ms的低脉冲，对于数据1，后面的高脉冲比较长，对于数据0，后面的高脉冲比较短。</p>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/04_data_wave.png"></p>
<p>第一次按下按键时，它会发出引导码，地址，地址取反，数据，数据取反。</p>
<p>如果这时还没松开按键，这就是“长按”，怎么表示“长按”？遥控器会发送一个不一样的引导码，这个引导码由9ms的低脉冲，2.25ms的高脉冲组成，表示现在按的还是上次一样的按键，也叫连发码，它会一直发送，直到松开。</p>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/05_repeat_wave.png"></p>
<h2 id="3-编程思路"><a href="#3-编程思路" class="headerlink" title="3. 编程思路"></a>3. 编程思路</h2><p>使用中断来实现：</p>
<ul>
<li>GPIO引脚配置为双边沿触发中断</li>
<li>记录中断发生时的时间</li>
<li>等接到完整的中断后，解析数据</li>
</ul>
<p><img src="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/06_use_irq.png" alt="image-20220106191056211"></p>
<h2 id="4-编程"><a href="#4-编程" class="headerlink" title="4. 编程"></a>4. 编程</h2><h3 id="4-1-中断方式"><a href="#4-1-中断方式" class="headerlink" title="4.1 中断方式"></a>4.1 中断方式</h3><h3 id="4-2-输入子系统"><a href="#4-2-输入子系统" class="headerlink" title="4.2 输入子系统"></a>4.2 输入子系统</h3><h1 id="24-实战-I2C设备驱动程序开发1-AT24C02程序框架"><a href="#24-实战-I2C设备驱动程序开发1-AT24C02程序框架" class="headerlink" title="24 实战_I2C设备驱动程序开发1_AT24C02程序框架"></a>24 实战_I2C设备驱动程序开发1_AT24C02程序框架</h1><h2 id="1-检查i2c1总线下的设备是否存在"><a href="#1-检查i2c1总线下的设备是否存在" class="headerlink" title="1 检查i2c1总线下的设备是否存在"></a>1 检查i2c1总线下的设备是否存在</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i2cdetect -y 0</span><br></pre></td></tr></table></figure>

<h2 id="2-i2c和输入系统的结合"><a href="#2-i2c和输入系统的结合" class="headerlink" title="2 i2c和输入系统的结合"></a>2 i2c和输入系统的结合</h2><ul>
<li>GT9xx</li>
<li>FT5x06</li>
</ul>
<h1 id="27-实战-SPI设备驱动开发1-OLED屏幕"><a href="#27-实战-SPI设备驱动开发1-OLED屏幕" class="headerlink" title="27 实战_SPI设备驱动开发1_OLED屏幕"></a>27 实战_SPI设备驱动开发1_OLED屏幕</h1></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://primaryo.github.io">Primary</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://primaryo.github.io/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">https://primaryo.github.io/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://primaryo.github.io" target="_blank">Zero One</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="/2024/03/19/%E9%A9%B1%E5%8A%A8%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/image-20231121160513624.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/./img/vx.jpg" target="_blank"><img class="post-qr-code-img" src="/./img/vx.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/./img/zfb.jpg" target="_blank"><img class="post-qr-code-img" src="/./img/zfb.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/03/19/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" title="通信协议"><img class="cover" src="/2024/03/19/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/image-20231102200224551.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-19</div><div class="title">通信协议</div></div></a></div><div><a href="/2024/03/01/Linux%E5%8D%A1%E7%89%87%E7%94%B5%E8%84%91/" title="Linux卡片电脑"><img class="cover" src="/2024/03/01/Linux%E5%8D%A1%E7%89%87%E7%94%B5%E8%84%91/image-20240301132644102.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-01</div><div class="title">Linux卡片电脑</div></div></a></div><div><a href="/2024/03/19/RT-Thread/" title="RT-Thread"><img class="cover" src="/2024/03/19/RT-Thread/image-20240314175714306.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-19</div><div class="title">RT-Thread</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/./img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Primary</div><div class="author-info__description">技术让梦想更伟大</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Primaryo"><i></i><span>🛴前往我的GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Primaryo" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:xxxxxx@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><center>本站域名:<br><a href="https://primaryo.github.io"><b><font color="#5ea6e5">primaryo.github.io</font></b></a><br>扣扣:<br><b><font color="#5ea6e5">965617116</font></b></a></center></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%8D%95%E7%89%87%E6%9C%BA%E5%92%8CLinux%E7%A8%8B%E5%BA%8F%E4%BB%8E%E4%B8%8A%E5%B1%82%E5%88%B0%E5%BA%95%E5%B1%82%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-number">1.</span> <span class="toc-text">1 单片机和Linux程序从上层到底层的比较</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A8%8B%E5%BA%8F%E6%AF%94%E8%BE%83"><span class="toc-number">1.1.</span> <span class="toc-text">1 程序比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">2 调用过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%89%93%E5%BC%80%E8%AE%BE%E5%A4%87%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">3 打开设备节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%9F%A5%E7%9C%8B%E6%94%AF%E6%8C%81%E7%9A%84%E8%AE%BE%E5%A4%87"><span class="toc-number">1.4.</span> <span class="toc-text">4 查看支持的设备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%A6%82%E4%BD%95%E5%86%99%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.5.</span> <span class="toc-text">5 如何写驱动</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%BD%BB%E5%BA%95%E5%88%86%E6%9E%90%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.</span> <span class="toc-text">2 彻底分析第一个驱动程序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9C%A8Ubuntu%E4%B8%AD%E9%80%9F%E4%BD%93%E9%AA%8C%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91"><span class="toc-number">2.1.</span> <span class="toc-text">1 在Ubuntu中速体验驱动开发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.</span> <span class="toc-text">2 驱动程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#V1-%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.0.1.</span> <span class="toc-text">V1 最简单的驱动程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#V2-%E9%A9%B1%E5%8A%A8%E5%85%A5%E5%8F%A3%E3%80%81%E5%87%BA%E5%8F%A3%E8%AF%A6%E8%A7%A3"><span class="toc-number">2.2.0.2.</span> <span class="toc-text">V2 驱动入口、出口详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#V3-%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E8%B0%83%E7%94%A8%E5%85%B3%E7%B3%BB"><span class="toc-number">2.2.0.3.</span> <span class="toc-text">V3 字符设备调用关系</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#V4-%E6%95%B0%E6%8D%AE%E4%BA%A4%E4%BA%92"><span class="toc-number">2.2.0.4.</span> <span class="toc-text">V4 数据交互</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E8%BE%85%E5%8A%A9%E4%BF%A1%E6%81%AF%E5%8F%8A%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4%E6%A6%82%E5%BF%B5"><span class="toc-number">3.</span> <span class="toc-text">3 驱动程序辅助信息及地址空间概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%80%9D%E8%80%83"><span class="toc-number">3.1.</span> <span class="toc-text">1 思考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="toc-number">3.2.</span> <span class="toc-text">2. 地址空间</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-CPU%E6%80%8E%E4%B9%88%E8%AE%BF%E9%97%AE%E5%A4%9A%E4%B8%AA%E5%A4%96%E8%AE%BE"><span class="toc-number">3.2.1.</span> <span class="toc-text">1 CPU怎么访问多个外设</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MCU"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">MCU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MPU"><span class="toc-number">3.2.1.2.</span> <span class="toc-text">MPU</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80"><span class="toc-number">3.2.2.</span> <span class="toc-text">2 为什么要引入虚拟地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%99%9A%E6%8B%9F%E5%9C%B0%E5%9D%80%E6%80%8E%E4%B9%88%E5%AF%B9%E5%BA%94%E5%88%B0%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80"><span class="toc-number">3.2.3.</span> <span class="toc-text">3 虚拟地址怎么对应到物理地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-Linux%E9%A9%B1%E5%8A%A8%E4%B8%AD%E6%80%8E%E4%B9%88%E8%AE%BF%E9%97%AE%E7%A1%AC%E4%BB%B6%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">3.2.4.</span> <span class="toc-text">4 Linux驱动中怎么访问硬件寄存器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E8%BE%85%E5%8A%A9%E4%BF%A1%E6%81%AF"><span class="toc-number">3.3.</span> <span class="toc-text">3 驱动程序辅助信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%9D%BF%E5%AD%90%E4%B8%8A%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C%E5%8F%8A%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">4 板子上驱动程序实际操作及编译过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%9C%A8%E5%86%85%E6%A0%B8%E7%9B%AE%E5%BD%95%E5%A4%96%E7%BC%96%E8%AF%91%E6%A8%A1%E5%9D%97"><span class="toc-number">4.0.1.</span> <span class="toc-text">1 在内核目录外编译模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%9C%A8%E5%86%85%E6%A0%B8%E7%9B%AE%E5%BD%95%E9%87%8C%E9%9D%A2%E7%BC%96%E8%AF%91%E9%A9%B1%E5%8A%A8"><span class="toc-number">4.0.2.</span> <span class="toc-text">2 在内核目录里面编译驱动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E5%88%86%E7%A6%BB%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E4%B8%8E%E6%80%BB%E7%BA%BF%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.</span> <span class="toc-text">5 分离的设计思想与总线设备驱动模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%88%86%E7%A6%BB%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3"><span class="toc-number">5.1.</span> <span class="toc-text">1 分离的设计思想</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%80%BB%E7%BA%BF%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">2 总线设备驱动模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99%E9%A9%B1%E5%8A%A8%E6%96%B9%E6%B3%95"><span class="toc-number">5.3.</span> <span class="toc-text">3 编写驱动方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E6%80%BB%E7%BA%BF%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B%E5%BD%BB%E5%BA%95%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">6 总线设备驱动模型彻底分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%8C%B9%E9%85%8D%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text">1 匹配方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B3%A8%E5%86%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">6.2.</span> <span class="toc-text">2 注册过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%A7%81%E6%9C%89%E6%95%B0%E6%8D%AE"><span class="toc-number">6.3.</span> <span class="toc-text">3 私有数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-%E8%AE%BE%E5%A4%87%E6%A0%91%E5%85%A5%E9%97%A8"><span class="toc-number">7.</span> <span class="toc-text">7 设备树入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%8F%8D%E6%B1%87%E7%BC%96dtb%E6%96%87%E4%BB%B6"><span class="toc-number">7.1.</span> <span class="toc-text">1 反汇编dtb文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9%E8%AF%AD%E6%B3%95"><span class="toc-number">7.2.</span> <span class="toc-text">2 设备树节点语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9"><span class="toc-number">7.3.</span> <span class="toc-text">3 创建设备树节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%AE%BE%E5%A4%87%E6%A0%91%E5%8C%B9%E9%85%8D%E8%BF%87%E7%A8%8B"><span class="toc-number">7.4.</span> <span class="toc-text">4 设备树匹配过程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E8%AE%BE%E5%A4%87%E6%A0%91%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.</span> <span class="toc-text">8 设备树示例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-LED%E5%92%8C%E6%8C%89%E9%94%AE%E7%9A%84%E8%AE%BE%E5%A4%87%E6%A0%91%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.1.</span> <span class="toc-text">1 LED和按键的设备树示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-I2C%E8%AE%BE%E5%A4%87%E6%A0%91%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.2.</span> <span class="toc-text">2 I2C设备树示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-SPI%E8%AE%BE%E5%A4%87%E6%A0%91%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.3.</span> <span class="toc-text">3 SPI设备树示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-LCD%E8%AE%BE%E5%A4%87%E6%A0%91%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.4.</span> <span class="toc-text">4 LCD设备树示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%AE%BE%E5%A4%87%E6%A0%91%E7%BC%96%E5%86%99%E6%96%B9%E6%B3%95"><span class="toc-number">8.5.</span> <span class="toc-text">5 设备树编写方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9-Pinctrl%E5%92%8CGPIO"><span class="toc-number">9.</span> <span class="toc-text">9 Pinctrl和GPIO</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Pinctrl"><span class="toc-number">9.1.</span> <span class="toc-text">1 Pinctrl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-GPIO"><span class="toc-number">9.2.</span> <span class="toc-text">2 GPIO</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%92%8C%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9B%B4%E5%A4%9A%E4%BA%A4%E4%BA%92%E6%96%B9%E5%BC%8F"><span class="toc-number">10.</span> <span class="toc-text">10 应用程序和驱动程序的更多交互方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-APP%E8%AF%BB%E5%8F%96%E6%8C%89%E9%94%AE%E5%80%BC%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-number">10.1.</span> <span class="toc-text">1 APP读取按键值的四种方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%AD%E6%96%AD%E7%B3%BB%E7%BB%9F%E7%9A%84%E8%AE%BE%E5%A4%87%E6%A0%91%E5%88%86%E6%9E%90"><span class="toc-number">10.2.</span> <span class="toc-text">2 中断系统的设备树分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-%E7%94%A8%E4%B8%80%E4%B8%AA%E7%A8%8B%E5%BA%8F%E6%80%BB%E7%BB%93%E9%A9%B1%E5%8A%A8%E6%9C%BA%E5%88%B6"><span class="toc-number">11.</span> <span class="toc-text">11 用一个程序总结驱动机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80"><span class="toc-number">12.</span> <span class="toc-text">12 驱动开发基础</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-%E5%AE%9E%E6%88%98-SR501%E4%BA%BA%E4%BD%93%E7%BA%A2%E5%A4%96%E6%A8%A1%E5%9D%97%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91"><span class="toc-number">13.</span> <span class="toc-text">13 实战_SR501人体红外模块驱动开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E7%BC%96%E5%86%99%E6%96%B9%E6%B3%95"><span class="toc-number">13.1.</span> <span class="toc-text">驱动编写方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">13.2.</span> <span class="toc-text">1原理图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9"><span class="toc-number">13.3.</span> <span class="toc-text">2 实现设备树节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6"><span class="toc-number">13.4.</span> <span class="toc-text">3 驱动框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%B5%8B%E8%AF%95"><span class="toc-number">13.5.</span> <span class="toc-text">4 测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%9F%A5%E7%9C%8B%E4%B8%AD%E6%96%AD"><span class="toc-number">13.6.</span> <span class="toc-text">5 查看中断</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#17-%E5%AE%9E%E6%88%98-SR04%E8%B6%85%E5%A3%B0%E6%B3%A2%E6%B5%8B%E8%B7%9D%E6%A8%A1%E5%9D%97%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91"><span class="toc-number">14.</span> <span class="toc-text">17 实战_SR04超声波测距模块驱动开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E7%BC%96%E5%86%99%E6%96%B9%E6%B3%95-1"><span class="toc-number">14.1.</span> <span class="toc-text">驱动编写方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-SR04%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">14.2.</span> <span class="toc-text">1 SR04工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-number">14.3.</span> <span class="toc-text">2 原理图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%96%B9%E6%B3%951-%E8%BD%AE%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="toc-number">14.4.</span> <span class="toc-text">3 方法1   轮询方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%96%B9%E6%B3%952%E4%B8%AD%E6%96%AD"><span class="toc-number">14.5.</span> <span class="toc-text">4 方法2	中断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%AE%9E%E7%8E%B0%E8%AE%BE%E5%A4%87%E6%A0%91%E8%8A%82%E7%82%B9"><span class="toc-number">14.6.</span> <span class="toc-text">5 实现设备树节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%BA%90%E7%A0%81"><span class="toc-number">14.7.</span> <span class="toc-text">6 源码</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18-%E5%AE%9E%E6%88%98-DHT11%E6%B8%A9%E6%B9%BF%E5%BA%A6%E4%BC%A0%E6%84%9F%E5%99%A8%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91"><span class="toc-number">15.</span> <span class="toc-text">18 实战_DHT11温湿度传感器驱动开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E7%BC%96%E5%86%99%E6%96%B9%E6%B3%95-2"><span class="toc-number">15.1.</span> <span class="toc-text">驱动编写方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-DHT11%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">15.2.</span> <span class="toc-text">1. DHT11工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%A1%AC%E4%BB%B6%E4%BF%A1%E5%8F%B7"><span class="toc-number">15.2.1.</span> <span class="toc-text">1.1 硬件信号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-number">15.2.2.</span> <span class="toc-text">1.2 数据格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BC%96%E7%A8%8B%E6%80%9D%E8%B7%AF"><span class="toc-number">15.3.</span> <span class="toc-text">2. 编程思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BC%96%E5%86%99%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">15.4.</span> <span class="toc-text">3. 编写驱动程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E6%96%B9%E6%B3%951-%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="toc-number">15.4.1.</span> <span class="toc-text">3.1 方法1: 查询方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E6%96%B9%E6%B3%952-%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F"><span class="toc-number">15.4.2.</span> <span class="toc-text">3.2 方法2: 中断方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%96%B9%E6%B3%953-%E4%BD%BF%E7%94%A8IIO%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="toc-number">15.4.3.</span> <span class="toc-text">3.3 方法3: 使用IIO子系统</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#21-%E5%AE%9E%E6%88%98-DS18B20%E9%A9%B1%E5%8A%A8%E7%BC%96%E7%A8%8B"><span class="toc-number">16.</span> <span class="toc-text">21 实战_DS18B20驱动编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A1%AC%E4%BB%B6%E8%BF%9E%E6%8E%A5"><span class="toc-number">16.1.</span> <span class="toc-text">1.  硬件连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">16.2.</span> <span class="toc-text">2. 访问流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%A1%AC%E4%BB%B6%E4%BF%A1%E5%8F%B7"><span class="toc-number">16.3.</span> <span class="toc-text">3. 硬件信号</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Start%E5%92%8C%E5%9B%9E%E5%BA%94"><span class="toc-number">16.3.1.</span> <span class="toc-text">3.1 Start和回应</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%86%99%E4%B8%80%E4%BD%8D%E6%95%B0%E6%8D%AE"><span class="toc-number">16.3.2.</span> <span class="toc-text">3.2 写一位数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%AF%BB%E4%B8%80%E4%BD%8D%E6%95%B0%E6%8D%AE"><span class="toc-number">16.3.3.</span> <span class="toc-text">3.3 读一位数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-DS18B20%E5%86%85%E9%83%A8%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">16.4.</span> <span class="toc-text">4. DS18B20内部寄存器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%BC%96%E5%86%99%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">16.5.</span> <span class="toc-text">5. 编写驱动程序</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#22-%E5%AE%9E%E6%88%98-%E7%BA%A2%E5%A4%96%E9%81%A5%E6%8E%A7%E5%99%A8HS0038%E7%9A%84%E4%B8%A4%E7%A7%8D%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">17.</span> <span class="toc-text">22 实战_红外遥控器HS0038的两种驱动程序</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%A1%AC%E4%BB%B6%E8%BF%9E%E6%8E%A5-1"><span class="toc-number">17.1.</span> <span class="toc-text">1.  硬件连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE"><span class="toc-number">17.2.</span> <span class="toc-text">2. 通信协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BC%96%E7%A8%8B%E6%80%9D%E8%B7%AF"><span class="toc-number">17.3.</span> <span class="toc-text">3. 编程思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%BC%96%E7%A8%8B"><span class="toc-number">17.4.</span> <span class="toc-text">4. 编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%B8%AD%E6%96%AD%E6%96%B9%E5%BC%8F"><span class="toc-number">17.4.1.</span> <span class="toc-text">4.1 中断方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E8%BE%93%E5%85%A5%E5%AD%90%E7%B3%BB%E7%BB%9F"><span class="toc-number">17.4.2.</span> <span class="toc-text">4.2 输入子系统</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#24-%E5%AE%9E%E6%88%98-I2C%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%8F%911-AT24C02%E7%A8%8B%E5%BA%8F%E6%A1%86%E6%9E%B6"><span class="toc-number">18.</span> <span class="toc-text">24 实战_I2C设备驱动程序开发1_AT24C02程序框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A3%80%E6%9F%A5i2c1%E6%80%BB%E7%BA%BF%E4%B8%8B%E7%9A%84%E8%AE%BE%E5%A4%87%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">18.1.</span> <span class="toc-text">1 检查i2c1总线下的设备是否存在</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-i2c%E5%92%8C%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%BB%93%E5%90%88"><span class="toc-number">18.2.</span> <span class="toc-text">2 i2c和输入系统的结合</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#27-%E5%AE%9E%E6%88%98-SPI%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%911-OLED%E5%B1%8F%E5%B9%95"><span class="toc-number">19.</span> <span class="toc-text">27 实战_SPI设备驱动开发1_OLED屏幕</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Primary</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script src="xxxx"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"]):not([href="/no-pjax/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:32.3%;}.categoryBar-list{max-height: 190px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 160px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://cdn.pixabay.com/photo/2016/10/20/18/35/earth-1756274_1280.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/Linux/&quot;);" href="javascript:void(0);">Linux</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">hexo指南</span></li><li class="categoryBar-list-item" style="background:url(https://cdn.pixabay.com/photo/2012/04/13/01/23/moon-31665_1280.png);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/架构/&quot;);" href="javascript:void(0);">架构</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">c语言代码</span></li><li class="categoryBar-list-item" style="background:url(https://cdn.pixabay.com/photo/2020/02/03/20/49/technology-4816658_1280.jpg);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/markdown/&quot;);" href="javascript:void(0);">markdown</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr">Linux驱动</span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/单片机/&quot;);" href="javascript:void(0);">单片机</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/STM32/&quot;);" href="javascript:void(0);">STM32</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/linux/&quot;);" href="javascript:void(0);">linux</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/嵌入式/&quot;);" href="javascript:void(0);">嵌入式</a><span class="categoryBar-list-count">12</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/数据结构/&quot;);" href="javascript:void(0);">数据结构</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(undefined);"> <a class="categoryBar-list-link" onclick="pjax.loadUrl(&quot;categories/操作系统/&quot;);" href="javascript:void(0);">操作系统</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('已挂载butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2024/03/01/Linux卡片电脑/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="2024/03/01/Linux卡片电脑/image-20240301132644102.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-03-01</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2024/03/01/Linux卡片电脑/&quot;);" href="javascript:void(0);" alt="">Linux卡片电脑</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2024/03/01/Linux卡片电脑/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2024/03/19/通信协议/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="2024/03/19/通信协议/image-20231102200224551.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-03-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2024/03/19/通信协议/&quot;);" href="javascript:void(0);" alt="">通信协议</a><div class="blog-slider__text">常用的通信协议</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2024/03/19/通信协议/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/10/21/ARM体系架构/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://tse3-mm.cn.bing.net/th/id/OIP-C.kjFfv4jLeUqAtdFJktUDiQHaEK?w=312&amp;h=180&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.3&amp;pid=1.7" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-10-21</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/10/21/ARM体系架构/&quot;);" href="javascript:void(0);" alt="">ARM体系架构</a><div class="blog-slider__text">帮助快速了解ARM架构</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/10/21/ARM体系架构/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2024/03/19/PC性能检测站/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="2024/03/19/PC性能检测站/image-20240301180803046.png" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2024-03-19</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2024/03/19/PC性能检测站/&quot;);" href="javascript:void(0);" alt="">PC性能检测站</a><div class="blog-slider__text">实战项目</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2024/03/19/PC性能检测站/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;2023/12/11/Linux知识点汇总/&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://tse2-mm.cn.bing.net/th/id/OIP-C.lh4fi-Kapb51zrbET9aXQQHaI4?w=131&amp;h=180&amp;c=7&amp;r=0&amp;o=5&amp;dpr=1.3&amp;pid=1.7" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2023-12-11</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;2023/12/11/Linux知识点汇总/&quot;);" href="javascript:void(0);" alt="">Linux知识点总结</a><div class="blog-slider__text">linux学习笔记</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;2023/12/11/Linux知识点汇总/&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>